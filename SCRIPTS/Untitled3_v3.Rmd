---
title: "Untitled3"
author: "Telha H. Rehman"
output:
  pdf_document: default
  html_document: default
---

# R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

# START

```{r}
Sys.time()
```

```{r, echo = FALSE}

library(knitr)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "~/Desktop/Ph.D. Horticulture and Agronomy/PhD_manuscript3/R_project/PhD_manuscript3")
```

```{r , message=FALSE}

library(tinytex)
library(ggplot2)
library(tidyverse)
library(cowplot)
library(Cairo)
library(modelr)
library(gridExtra)
library(mixtools)
library(nlme)
library(car)
library(emmeans)
library(MuMIn)
library(ggpmisc)
library(gridExtra)
library(gtable)
library(grid)
library(RColorBrewer)
library(segmented)
library(data.table)
library(scales)

```

#DATA

##GreenSeeker NDVI Data

```{r}

gs_ndvi_data <- read_csv(file = "DATA/PI_greenseeker_data.csv")

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <- gs_ndvi_data %>% 
  filter(!year %in% c("2015" , "2016"),
         N_level_kgha != 275) #remove the years we don't need for this analysis and also the N rate that is too high 

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <- gs_ndvi_data[c(1:240), c(1:17)] #removes the empty rows and columns from the data frame

gs_ndvi_data$block <- factor(gs_ndvi_data$block) 
gs_ndvi_data$year <- factor(gs_ndvi_data$year)
gs_ndvi_data$plot <- factor(gs_ndvi_data$plot) 
gs_ndvi_data$N_level_kgha_f <- factor(gs_ndvi_data$N_level_kgha)
gs_ndvi_data$exp_plot_number <- factor(gs_ndvi_data$exp_plot_number)
gs_ndvi_data$site_year <- factor(gs_ndvi_data$site_year , levels = c( "Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19" ))
gs_ndvi_data$NDVI_1 <- as.numeric(as.character(gs_ndvi_data$NDVI_1))
gs_ndvi_data$NDVI_2 <- as.numeric(as.character(gs_ndvi_data$NDVI_2))
gs_ndvi_data$NDVI_3 <- as.numeric(as.character(gs_ndvi_data$NDVI_3))
gs_ndvi_data$NDVI_4 <- as.numeric(as.character(gs_ndvi_data$NDVI_4)) #gets the data right

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <-  gs_ndvi_data %>% 
  mutate( biomass_dry_wt = biomass_plus_bag_g - (paper_bag_g * num_of_paper_bags) ,
          aboveground_biomass = (biomass_dry_wt / ring_size) * 10 ,
          n_content = sample_N_ug / sample_weight_mg ,
          PI_N_Uptake = (aboveground_biomass * n_content) / 1000 #n uptake in kg per ha
          )#processes the data


gs_ndvi_data <- gs_ndvi_data %>% 
  rowwise() %>% 
  mutate(NDVI = mean(c( NDVI_1 , NDVI_2 , NDVI_3 , NDVI_4) , na.rm = T)) #takes average of four NDVI readings

gs_ndvi_data <- dplyr::select(gs_ndvi_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      block,
                      plot,
                      N_level_kgha,
                      aboveground_biomass,
                      n_content,
                      PI_N_Uptake,
                      NDVI) #selects the relevant columns

gs_ndvi_data$site_year <- factor(gs_ndvi_data$site_year , levels = c( "Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19")) #orders site-years alphabetically

gs_ndvi_data$NDVI <- round(gs_ndvi_data$NDVI , digits = 2) #rounds to the precision of the instrument

hist(gs_ndvi_data$aboveground_biomass)
hist(gs_ndvi_data$n_content)
hist(gs_ndvi_data$PI_N_Uptake)
```

## Yield Data
```{r}

yield_data <- read_csv(file = "DATA/yield_data.csv")

str(yield_data , give.attr = FALSE)

yield_data <- yield_data %>% 
  filter(!year %in% c( "2016"),
         N_level != "275") #removing the years and  N rate to match with NDVI data

yield_data <- yield_data %>% 
  mutate(
    site_year = factor(site_year),
    year = factor(year),
    Block = factor(Block),
    MainPlot = factor(MainPlot),
    exp_plot_number = factor(exp_plot_number),
    N_level = factor(N_level),
    SubPlot = factor(SubPlot),
    TopDress = factor(TopDress),
    SeasonalNRate_f = factor(SeasonalNRate),
    N_level_kgha_f = factor(N_level_kgha),
    TopDress_kgha_f = factor(TopDress_kgha),
    SeasonalNRate_kgha_f = factor(SeasonalNRate_kgha)
    ) #changes these columns to factor

str(yield_data , give.attr = FALSE)

yield_data <- yield_data %>% 
  mutate(
    FW1net = FW1PlusTare - tare,
    FW2net = FW2PlusTare - tare,
    TotalFW = FW1net + FW2net,
    SSFWnet = SSFWPlusTare - tare,
    Ratio = SSFWnet / TotalFW, 
    SSODWnet = SSODW - HarvestBagPlusTie, 
    SeedTray1 = SeedTray1.1 + SeedTray1.2, #adds the decimal to the 243g to get the tare weight for the seedtray
    Grain3net = Grain3PlusSeedTray1 - SeedTray1, #subtract tare of seed tray from grain3. Grain3 is the reweighed sample value
    Grain4net = Grain4PlusSeedTray2 - SeedTray2, #grain4 is the amount of grain removed for ballmilling. this value came from another excel sheet
    Grain2net = Grain2PlusPaperBag2 - PaperBag2, #yield component grain sample
    Grain2net = Grain2net * Ratio, #this essentially subsamples the yield component grain sample
    GrainNet = Grain3net + Grain4net + Grain2net, #add the grain removed for ball milling and yield component back to the reweighed grain sample
    GrainRing = GrainNet / Ratio, #the amount of grain in the entire m^2 ring in grams
    GrainYield = GrainRing * 10, #g/m^2 to kg/ha
    GrainYield_kgha = GrainYield * ((100-MoistureContentGrain3)/86),#corrects for 14% moisture based on the moisture content readings from grain reweighing. values came from another excel sheet
    GrainYield_Mgha = GrainYield_kgha / 1000 , #converts kg/ha to Mg/ha
    Grain5 = GrainRing * ((100-MoistureContentGrain3)/98.1), #grain in the ring if the subsample was at 1.9% moisture
    Grain6 = GrainNet * ((100-MoistureContentGrain3)/98.1), #grain in the subsample if it was at 1.9% moisture
    StrawSS = SSODWnet - Grain6 , #just straw in subsample in grams 
    StrawRing = StrawSS / Ratio, #straw in ring in grams i.e g/m2
    StrawNcon = StrawN / StrawSampleSize,
    StrawNup = (StrawRing * StrawNcon) / 100, #straw Nup divide by 100 to convert mg/m2 to kg/ha - this is correct
    GrainNcon = (GrainN / GrainSampleSize), #grain in ring in kg/ha
    GrainNup = (Grain5 * GrainNcon) / 100, #grain Nup divide by 100 to convert mg N/m2 to kg N/ha
    TotalSeasonalNup = StrawNup + GrainNup, #in kg/ha
    HarvestIndex = Grain5 / (Grain5 + StrawRing),
    Moisture = SSFWnet / SSODWnet
    )

boxplot(yield_data$GrainYield_Mgha)
hist(yield_data$GrainYield_Mgha)

boxplot(yield_data$HarvestIndex)
hist(yield_data$HarvestIndex)

boxplot(yield_data$Moisture)
hist(yield_data$Moisture)

```

```{r}

#the data looks good - don't see any unusual values


yield_data <- dplyr::select(yield_data,
                               site_year,
                               year,
                               Block,
                               MainPlot,
                               SubPlot,
                               exp_plot_number,
                               N_level_kgha,
                               N_level_kgha_f,
                               TopDress_kgha, 
                               TopDress_kgha_f,
                               GrainYield_Mgha
                               )
           

gs_data <- full_join(gs_ndvi_data , yield_data)

gs_data <- dplyr::select(gs_data, 
               site_year, 
               year, 
               exp_plot_number, 
               Block, 
               MainPlot, 
               SubPlot,
               N_level_kgha,
               N_level_kgha_f,
               TopDress_kgha, 
               TopDress_kgha_f , 
               PI_N_Uptake, 
               NDVI, 
               GrainYield_Mgha) #reorders the columns

gs_data$site_year <- as.factor(gs_data$site_year)

str(gs_data , give.attr = FALSE)

boxplot(gs_data$GrainYield_Mgha)

hist(gs_data$GrainYield_Mgha)

hist(gs_data$NDVI)

boxplot(gs_data$NDVI)

boxplot(gs_data$PI_N_Uptake)

hist(gs_data$PI_N_Uptake)

#Overall data looks good -- no errors of data entry

```

##Data for Table 3
```{r}

table_3_data <- gs_data %>% 
  select(site_year , TopDress_kgha_f , GrainYield_Mgha) %>% 
  group_by(site_year , TopDress_kgha_f) %>% 
  summarise(GrainYield_min = min(GrainYield_Mgha),
            GrainYield_max = max(GrainYield_Mgha),
            GrainYield_mean = mean(GrainYield_Mgha)) %>% 
  ungroup()
    
table_3_data$GrainYield_min <- round(table_3_data$GrainYield_min , digits = 1)
table_3_data$GrainYield_max <- round(table_3_data$GrainYield_max , digits = 1)
table_3_data$GrainYield_mean <- round(table_3_data$GrainYield_mean , digits = 1)

```


## Calculating GS RI

```{r}

max_gs_ndvi <- gs_data %>% 
  filter(N_level_kgha_f %in% c(225, 235) & TopDress_kgha_f == 0) %>% 
  select(site_year , NDVI) %>% 
  group_by(site_year) %>% 
  summarise(mean_NDVI = mean(NDVI))

max_gs_ndvi$mean_NDVI <- round(max_gs_ndvi$mean_NDVI , digits = 2)

nic17 <- subset(max_gs_ndvi, site_year == "Nicolaus-17")
nic17maxNDVI <- nic17$mean_NDVI
nic17maxNDVI <- as.numeric(nic17maxNDVI)
nic17maxNDVI

wil17 <- subset(max_gs_ndvi, site_year == "Williams-17")
wil17maxNDVI <- wil17$mean_NDVI
wil17maxNDVI <- as.numeric(wil17maxNDVI)
wil17maxNDVI

arb18 <- subset(max_gs_ndvi, site_year == "Arbuckle-18")
arb18maxNDVI <- arb18$mean_NDVI
arb18maxNDVI <- as.numeric(arb18maxNDVI)
arb18maxNDVI

biggs18 <- subset(max_gs_ndvi, site_year == "Biggs-18")
biggs18maxNDVI <- biggs18$mean_NDVI
biggs18maxNDVI <- as.numeric(biggs18maxNDVI)
biggs18maxNDVI

mry18 <- subset(max_gs_ndvi, site_year == "Marysville-18")
mry18maxNDVI <- mry18$mean_NDVI
mry18maxNDVI <- as.numeric(mry18maxNDVI)
mry18maxNDVI

nic18 <- subset(max_gs_ndvi, site_year == "Nicolaus-18")
nic18maxNDVI <- nic18$mean_NDVI
nic18maxNDVI <- as.numeric(nic18maxNDVI)
nic18maxNDVI

arb19 <- subset(max_gs_ndvi, site_year == "Arbuckle-19")
arb19maxNDVI <- arb19$mean_NDVI
arb19maxNDVI <- as.numeric(arb19maxNDVI)
arb19maxNDVI

davis19 <- subset(max_gs_ndvi, site_year == "Davis-19")
davis19maxNDVI <- davis19$mean_NDVI
davis19maxNDVI <- as.numeric(davis19maxNDVI)
davis19maxNDVI

mry19 <- subset(max_gs_ndvi, site_year == "Marysville-19")
mry19maxNDVI <- mry19$mean_NDVI
mry19maxNDVI <- as.numeric(mry19maxNDVI)
mry19maxNDVI

res19 <- subset(max_gs_ndvi, site_year == "RES-19")
res19maxNDVI <- res19$mean_NDVI
res19maxNDVI <- as.numeric(res19maxNDVI)
res19maxNDVI

gs_data <- gs_data %>% 
  mutate(max_NDVI = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxNDVI ,
                          site_year == "Williams-17" ~ wil17maxNDVI ,
                          site_year == "Arbuckle-18" ~ arb18maxNDVI ,
                          site_year == "Biggs-18" ~ biggs18maxNDVI ,
                          site_year == "Marysville-18" ~ mry18maxNDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxNDVI,
                          site_year == "Arbuckle-19" ~ arb19maxNDVI ,
                          site_year == "Davis-19" ~ davis19maxNDVI ,
                          site_year == "Marysville-19" ~ mry19maxNDVI ,
                          site_year == "RES-19" ~ res19maxNDVI)
  )

gs_data <- gs_data %>%
  mutate(gs_NDVI_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxNDVI / NDVI,
                          site_year == "Williams-17" ~ wil17maxNDVI / NDVI,
                          site_year == "Arbuckle-18" ~ arb18maxNDVI / NDVI ,
                          site_year == "Biggs-18" ~ biggs18maxNDVI / NDVI ,
                          site_year == "Marysville-18" ~ mry18maxNDVI / NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxNDVI / NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxNDVI / NDVI,
                          site_year == "Davis-19" ~ davis19maxNDVI / NDVI,
                          site_year == "Marysville-19" ~ mry19maxNDVI / NDVI,
                          site_year == "RES-19" ~ res19maxNDVI / NDVI
                        )) #calculates NDVI response index

str(gs_data , give.attr = FALSE)

hist(gs_data$gs_NDVI_Response_Index)
boxplot(gs_data$gs_NDVI_Response_Index)
hist(gs_data$GrainYield_Mgha)
boxplot(gs_data$GrainYield_Mgha)

gs_data$gs_NDVI_Response_Index[gs_data$gs_NDVI_Response_Index < 1] <- 1 #converts values less than 1, to 1.

```

##Drone Data

```{r}

drone_data <- read_csv(file = "DATA/PI_drone_data.csv")

drone_data <- drone_data %>% 
  filter(N_level_kgha != 275)

str(drone_data , give.attr = FALSE)

drone_data <- drone_data %>% 
  mutate(year = factor(year) ,
         exp_plot_number = factor(exp_plot_number) ,
         Block = factor(Block) ,
         MainPlot = factor(MainPlot) ,
         N_level = factor(N_level) ,
         N_level_kgha_f = factor(N_level_kgha)
  )

drone_data$site_year <- factor(drone_data$site_year , levels = c("Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19"))

str(drone_data , give.attr = FALSE)


drone_data <- dplyr::select(drone_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      N_level,
                      N_level_kgha,
                      N_level_kgha_f,
                      biomass_plus_bag_g,
                      ring_size,
                      paper_bag_g,
                      num_of_paper_bags,
                      sample_weight_mg,
                      sample_N_ug,
                      bluemean,
                      greenmean,
                      redmean,
                      edgemean,
                      nirmean
                      )#selects the relevant columns

str(drone_data , give.attr = FALSE)

#visualize drone_data to look for outliers

boxplot(drone_data$bluemean)
hist(drone_data$bluemean)

boxplot(drone_data$greenmean)
hist(drone_data$greenmean)

boxplot(drone_data$redmean)
hist(drone_data$redmean)

boxplot(drone_data$edgemean)
hist(drone_data$edgemean)

boxplot(drone_data$nirmean)
hist(drone_data$nirmean)

```

```{r}

drone_data <-  drone_data %>% 
  mutate( biomass_dry_wt = biomass_plus_bag_g - (paper_bag_g * num_of_paper_bags) ,
          aboveground_biomass = (biomass_dry_wt / ring_size) * 10 , #ring size 0.5 m^2 biomass in kg per ha
          n_content = sample_N_ug / sample_weight_mg ,
          PI_N_Uptake = (aboveground_biomass * n_content) / 1000 #n uptake in kg per ha
          )#processes the data2

boxplot(drone_data$PI_N_Uptake)
hist(drone_data$PI_N_Uptake)

drone_data <- drone_data %>% 
  mutate(uas_NDRE = ((nirmean - edgemean) / (nirmean + edgemean)) ,
         uas_NDVI = ((nirmean - redmean) / (nirmean + redmean))
         ) #calculates NDRE and NDVI

boxplot(drone_data$uas_NDRE)
hist(drone_data$uas_NDRE)

boxplot(drone_data$uas_NDVI)
hist(drone_data$uas_NDVI)

ggplot(data = drone_data, aes(x = PI_N_Uptake , y = uas_NDRE )) +
  geom_point(mapping = aes(x = PI_N_Uptake , y = uas_NDRE , shape = site_year) , data = drone_data) +
  theme_classic() +
  scale_shape_manual(values = seq(4:20)) +
  coord_cartesian(ylim = c(0,1))

ggplot(data = drone_data, aes(x = PI_N_Uptake , y = uas_NDVI )) +
  geom_point(mapping = aes(x = PI_N_Uptake , y = uas_NDVI , shape = site_year) , data = drone_data) +
  theme_classic() +
  scale_shape_manual(values = seq(4:20)) +
  coord_cartesian(ylim = c(0,1))
  
drone_data$uas_NDRE <- round(drone_data$uas_NDRE , digits = 2) #rounds to the precision of the instrument
drone_data$uas_NDVI <- round(drone_data$uas_NDVI , digits = 2) #rounds to the precision of the instrument

```

## Calculating UAS RI
```{r}
#gets the max NDRE value for each site

max_drone_data <- drone_data %>% 
  filter(N_level_kgha_f %in% c(225, 235)) %>% 
  select(site_year , uas_NDVI , uas_NDRE) %>% 
  group_by(site_year) %>% 
  summarise_all(.funs = mean) %>% 
  ungroup()

max_drone_data$uas_NDVI <- round(max_drone_data$uas_NDVI , digits = 2)
max_drone_data$uas_NDRE <- round(max_drone_data$uas_NDRE , digits = 2)

nic17 <- subset(max_drone_data, site_year == "Nicolaus-17")
nic17maxuas_NDRE <- as.numeric(nic17$uas_NDRE)
nic17maxuas_NDRE
nic17maxuas_NDVI <- as.numeric(nic17$uas_NDVI)
nic17maxuas_NDVI

wil17 <- subset(max_drone_data, site_year == "Williams-17")
wil17maxuas_NDRE <- as.numeric(wil17$uas_NDRE)
wil17maxuas_NDRE
wil17maxuas_NDVI <- as.numeric(wil17$uas_NDVI)
wil17maxuas_NDVI

arb18 <- subset(max_drone_data, site_year == "Arbuckle-18")
arb18maxuas_NDRE <- as.numeric(arb18$uas_NDRE)
arb18maxuas_NDRE
arb18maxuas_NDVI <- as.numeric(arb18$uas_NDVI)
arb18maxuas_NDVI

biggs18 <- subset(max_drone_data, site_year == "Biggs-18")
biggs18maxuas_NDRE <- as.numeric(biggs18$uas_NDRE)
biggs18maxuas_NDRE
biggs18maxuas_NDVI <- as.numeric(biggs18$uas_NDVI)
biggs18maxuas_NDVI

mry18 <- subset(max_drone_data, site_year == "Marysville-18")
mry18maxuas_NDRE <- as.numeric(mry18$uas_NDRE)
mry18maxuas_NDRE
mry18maxuas_NDVI <- as.numeric(mry18$uas_NDVI)
mry18maxuas_NDVI

nic18 <- subset(max_drone_data, site_year == "Nicolaus-18")
nic18maxuas_NDRE <- as.numeric(nic18$uas_NDRE)
nic18maxuas_NDRE
nic18maxuas_NDVI <- as.numeric(nic18$uas_NDVI)
nic18maxuas_NDVI

arb19 <- subset(max_drone_data, site_year == "Arbuckle-19")
arb19maxuas_NDRE <- as.numeric(arb19$uas_NDRE)
arb19maxuas_NDRE
arb19maxuas_NDVI <- as.numeric(arb19$uas_NDVI)
arb19maxuas_NDVI

davis19 <- subset(max_drone_data, site_year == "Davis-19")
davis19maxuas_NDRE <- as.numeric(davis19$uas_NDRE)
davis19maxuas_NDRE
davis19maxuas_NDVI <- as.numeric(davis19$uas_NDVI)
davis19maxuas_NDVI

mry19 <- subset(max_drone_data, site_year == "Marysville-19")
mry19maxuas_NDRE <- as.numeric(mry19$uas_NDRE)
mry19maxuas_NDRE
mry19maxuas_NDVI <- as.numeric(mry19$uas_NDVI)
mry19maxuas_NDVI

res19 <- subset(max_drone_data, site_year == "RES-19")
res19maxuas_NDRE <- as.numeric(res19$uas_NDRE)
res19maxuas_NDRE
res19maxuas_NDVI <- as.numeric(res19$uas_NDVI)
res19maxuas_NDVI

drone_data <- drone_data %>% 
  mutate(max_uas_NDRE = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDRE ,
                          site_year == "Williams-17" ~ wil17maxuas_NDRE ,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDRE ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDRE ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDRE ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDRE,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDRE ,
                          site_year == "Davis-19" ~ davis19maxuas_NDRE ,
                          site_year == "Marysville-19" ~ mry19maxuas_NDRE ,
                          site_year == "RES-19" ~ res19maxuas_NDRE) #assign the max NDRE value for each site
  )

drone_data <- drone_data %>%
  mutate(uas_NDRE_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDRE / uas_NDRE,
                          site_year == "Williams-17" ~ wil17maxuas_NDRE / uas_NDRE,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDRE / uas_NDRE  ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDRE / uas_NDRE ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDRE / uas_NDRE ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDRE / uas_NDRE,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDRE / uas_NDRE,
                          site_year == "Davis-19" ~ davis19maxuas_NDRE / uas_NDRE,
                          site_year == "Marysville-19" ~ mry19maxuas_NDRE / uas_NDRE,
                          site_year == "RES-19" ~ res19maxuas_NDRE / uas_NDRE
                        )) #calculates uas_NDRE response index

drone_data <- drone_data %>% 
  mutate(max_uas_NDVI = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDVI ,
                          site_year == "Williams-17" ~ wil17maxuas_NDVI ,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDVI ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDVI ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDVI ,
                          site_year == "Davis-19" ~ davis19maxuas_NDVI ,
                          site_year == "Marysville-19" ~ mry19maxuas_NDVI ,
                          site_year == "RES-19" ~ res19maxuas_NDVI) #assign max ndvi value for each site
  )

drone_data <- drone_data %>%
  mutate(uas_NDVI_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDVI / uas_NDVI,
                          site_year == "Williams-17" ~ wil17maxuas_NDVI / uas_NDVI,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDVI / uas_NDVI  ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDVI / uas_NDVI ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDVI / uas_NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDVI / uas_NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDVI / uas_NDVI,
                          site_year == "Davis-19" ~ davis19maxuas_NDVI / uas_NDVI,
                          site_year == "Marysville-19" ~ mry19maxuas_NDVI / uas_NDVI,
                          site_year == "RES-19" ~ res19maxuas_NDVI / uas_NDVI
                        )) #calculates uas_NDVI response index

str(drone_data , give.attr =  F)

boxplot(drone_data$uas_NDRE_Response_Index)
hist(drone_data$uas_NDRE_Response_Index)

boxplot(drone_data$uas_NDVI_Response_Index)
hist(drone_data$uas_NDVI_Response_Index)

drone_data$uas_NDVI_Response_Index[drone_data$uas_NDVI_Response_Index < 1] <- 1 #converts values less than 1, to 1.
drone_data$uas_NDRE_Response_Index[drone_data$uas_NDRE_Response_Index < 1] <- 1 #converts values less than 1, to 1.

```


```{r}

drone_data <- dplyr::select(drone_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      N_level_kgha,
                      N_level_kgha_f,
                      PI_N_Uptake,
                      uas_NDRE,
                      uas_NDVI,
                      uas_NDRE_Response_Index,
                      uas_NDVI_Response_Index
                      )#selects the relevant columns

sUAS_yield_data <- yield_data

sUAS_yield_data$site_year <- factor(sUAS_yield_data$site_year , levels = c("Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19"))

str(drone_data , give.attr = F)
str(sUAS_yield_data , give.attr = F)

sUAS_data <- full_join( drone_data , sUAS_yield_data)

sUAS_data <- dplyr::select(sUAS_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      SubPlot,
                      N_level_kgha,
                      N_level_kgha_f,
                      TopDress_kgha,
                      TopDress_kgha_f,
                      PI_N_Uptake,
                      uas_NDRE,
                      uas_NDVI,
                      GrainYield_Mgha,
                      uas_NDRE_Response_Index,
                      uas_NDVI_Response_Index
                      )#selects the relevant columns


str(sUAS_data , give.attr = F)

```

##Combining the data
```{r}

gs_data <- gs_data %>% 
  mutate(gs_NDVI_SI = 1 / gs_NDVI_Response_Index)

sUAS_data <- sUAS_data %>% 
  mutate(uas_NDVI_SI = 1 / uas_NDVI_Response_Index)

sUAS_data <- sUAS_data %>% 
  mutate(uas_NDRE_SI = 1 / uas_NDRE_Response_Index)

gs_data <- gs_data %>% 
  dplyr::select(site_year ,
                year,
                exp_plot_number,
                Block,
                MainPlot,
                SubPlot,
                N_level_kgha,
                N_level_kgha_f,
                TopDress_kgha,
                TopDress_kgha_f,
                PI_N_Uptake, 
                NDVI, 
                GrainYield_Mgha,
                gs_NDVI_Response_Index,
                gs_NDVI_SI
         )

sUAS_data <- sUAS_data %>% 
  dplyr::select(site_year ,
                year,
                exp_plot_number,
                Block,
                MainPlot,
                SubPlot,
                N_level_kgha,
                N_level_kgha_f,
                TopDress_kgha,
                TopDress_kgha_f,
                uas_NDRE,
                uas_NDVI,
                uas_NDVI_Response_Index,
                uas_NDVI_SI,
                uas_NDRE_Response_Index,
                uas_NDRE_SI
         )

paper3_data <- full_join(gs_data , sUAS_data)

```


```{r}

paper3_gsdata <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                NDVI,
                gs_NDVI_Response_Index,
                gs_NDVI_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "GreenSeeker_NDVI" ,
        SI_sq = (gs_NDVI_SI * gs_NDVI_SI)) %>% 
  rename(Index = NDVI , 
         SI = gs_NDVI_SI,
         RI = gs_NDVI_Response_Index)

paper3_uas_ndvi_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                uas_NDVI,
                uas_NDVI_Response_Index,
                uas_NDVI_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "sUAS_NDVI" ,
         SI_sq = (uas_NDVI_SI * uas_NDVI_SI)) %>% 
  rename(Index = uas_NDVI,
         SI = uas_NDVI_SI,
         RI = uas_NDVI_Response_Index)

paper3_uas_ndre_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                uas_NDRE ,
                uas_NDRE_Response_Index ,
                uas_NDRE_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "sUAS_NDRE" ,
         SI_sq = (uas_NDRE_SI * uas_NDRE_SI)) %>% 
  rename(Index = uas_NDRE ,
         SI = uas_NDRE_SI,
         RI = uas_NDRE_Response_Index)

paper3_data <- rbind(paper3_gsdata ,
                     paper3_uas_ndvi_data , 
                     paper3_uas_ndre_data)

paper3_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                Platform,
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                Index,
                RI,
                SI ,
                SI_sq ,
                GrainYield_Mgha,
                PI_N_Uptake)

paper3_data$Platform <- as.factor(paper3_data$Platform)

str(paper3_data , give.attr = F)

paper3_data <- tibble::rowid_to_column(paper3_data, "ID") #adds a columns with row number.

paper3_data <- paper3_data %>% 
  filter(!ID %in% c(193 , 194 , 721 , 722, 1249 , 1250)) #removes Biggs-18 101 plot bc tractor ran through it

paper3_data$Platform = factor(paper3_data$Platform, levels=c("GreenSeeker_NDVI" , "sUAS_NDVI" , "sUAS_NDRE"))

boxplot(paper3_data$RI ~ paper3_data$Platform)

paper3_data$RI <- round(paper3_data$RI , digits = 3)
paper3_data$SI <- round(paper3_data$SI , digits = 3)
paper3_data$SI_sq <- round(paper3_data$SI_sq , digits = 3)

```

##Histogram Plot

```{r}

hist_data <- paper3_data %>% 
  select(Platform , Index) %>% 
  group_by(Platform) %>% 
  summarise(mean = mean(Index) , sd = sd(Index))

hist_data$mean = round(hist_data$mean , digits = 2)
hist_data$sd = round(hist_data$sd , digits = 2)

#This plot is for the legend
ggplot( data = paper3_data , aes(x = Index)) +
  geom_histogram( data = paper3_data , aes(x = Index , color = Platform) , binwidth = .01 , fill = "grey") +
  coord_cartesian(xlim = c(0 , 1) , ylim = c(0,80)) +
  scale_y_continuous(breaks = seq(0,100 , by = 10)) +
  scale_x_continuous(breaks = seq(0 , 1 , by = 0.1)) +
  scale_color_discrete( name = "Index" , labels = c("GreenSeeker NDVI" , "sUAS NDVI" , "sUAS NDRE"))

gs_ndvi_hist <- ggplot( data = paper3_gsdata , aes(x = Index)) +
  geom_histogram( data = paper3_gsdata , aes(x = Index , color = Platform) , binwidth = .01 , fill = "grey") +
  theme_classic() +
  coord_cartesian(xlim = c(0 , 1) , ylim = c(0,80)) +
  scale_y_continuous(breaks = seq(0,100 , by = 10)) +
  scale_x_continuous(breaks = seq(0 , 1 , by = 0.1)) +
  theme(legend.position = "none") +
  labs(x = "Index Value" , y = "Frequency") +
  theme(axis.title = element_text(size = 28),
        axis.text = element_text(size = 28))

gs_ndvi_hist

suas_ndvi_hist <- ggplot( data = paper3_uas_ndvi_data , aes(x = Index)) +
  geom_histogram( data = paper3_uas_ndvi_data , aes(x = Index ) , binwidth = .01 , fill = "grey" , color = "#619CFF") +
  theme_classic() +
  coord_cartesian(xlim = c(0 , 1) , ylim = c(0,80)) +
  scale_y_continuous(breaks = seq(0,100 , by = 10)) +
  scale_x_continuous(breaks = seq(0 , 1 , by = 0.1)) +
  theme(legend.position = "none") +
  labs(x = "Index Value" , y = "Frequency") +
  theme(axis.title = element_text(size = 28),
        axis.text = element_text(size = 28))
  
suas_ndvi_hist

overlay_hist <- ggplot( data = paper3_data, aes( x = Index)) + 
    geom_histogram(data = subset(paper3_data , Platform == 'GreenSeeker_NDVI') , aes(x = Index , fill = Platform ) , binwidth = .01 , alpha = 0.5) +
    geom_histogram(data = subset(paper3_data , Platform == 'sUAS_NDVI'), aes(x = Index , fill = Platform ) , binwidth = .01 , alpha = 0.5) +
    geom_histogram(data = subset(paper3_data , Platform == 'sUAS_NDRE'), aes(x = Index , fill = Platform ) , binwidth = .01 , alpha = 0.5) +
  theme_classic() +
  coord_cartesian(xlim = c(0.15 , .95) , ylim = c(0,80)) +
  scale_y_continuous(breaks = seq(0,100 , by = 10)) +
  scale_x_continuous(breaks = seq(0 , 1 , by = 0.1)) +
  labs(x = "Index Value" , y = "Frequency") +
  theme(axis.title = element_text(size = 28),
        axis.text = element_text(size = 28),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24)) +
  geom_hline(yintercept = 0) +
  scale_fill_discrete( name = "Index" , labels = c("GreenSeeker NDVI" , "sUAS NDVI" , "sUAS NDRE")) +
  geom_segment(aes(x = 0.65, y = 0, xend = 0.65, yend = Inf), linetype = "dashed" , size  = 2 , alpha = 0.5 , color = "#F8766D" ) +
  geom_segment(aes(x = 0.88, y = 0, xend = 0.88, yend = Inf) ,linetype = "dashed" , size = 2 , alpha = 0.5 , color = "#619CFF" ) +
  geom_segment(aes(x = 0.60, y = 0, xend = 0.60, yend = Inf), linetype = "dashed" , size = 2 , alpha = 0.5 , color = "#00BA38")

overlay_hist

ggsave("FIGURES/Paper3_overlay_hist.tiff" , overlay_hist , compression = "lzw" , width = 16 , height = 12, type = "cairo" , dpi = 750)
```

##Data for Table 2

```{r}

table_2_data_1 <- paper3_data %>% 
  select(site_year , Platform , Index , RI) %>% 
  group_by(site_year , Platform) %>% 
  summarise(Index_min = min(Index),
            Index_max = max(Index),
            RI_min = min(RI),
            RI_max = max(RI)) %>% 
  ungroup()
    
table_2_data_1$Index_min <- round(table_2_data_1$Index_min , digits = 2)
table_2_data_1$Index_max <- round(table_2_data_1$Index_max , digits = 2)
table_2_data_1$RI_min <- round(table_2_data_1$RI_min , digits = 2)
table_2_data_1$RI_max <- round(table_2_data_1$RI_max , digits = 2)

table_2_data_2 <- paper3_data %>% 
  select(site_year , Platform , PI_N_Uptake) %>% 
  group_by(site_year , Platform) %>% 
  filter(Platform == "GreenSeeker_NDVI") %>% 
  summarise(PI_N_Uptake_min = min(PI_N_Uptake),
            PI_N_Uptake_max = max(PI_N_Uptake)) %>% 
  ungroup()

table_2_data_2$PI_N_Uptake_min <- round(table_2_data_2$PI_N_Uptake_min , digits = 0)
table_2_data_2$PI_N_Uptake_max <- round(table_2_data_2$PI_N_Uptake_max , digits = 0)
  

```

#FIGURES

##PI Nup ~ Index Fig

```{r}

label_text <- data.frame( 
  label = c("A" ,
            "B",
            "C"
) ,
  Platform = factor(c("GreenSeeker_NDVI" ,
               "sUAS_NDVI" ,
            "sUAS_NDRE"
            )),
  x_position = c(0 , 0 , 0 ) ,
  y_position = c(1 , 1 , 1 ))

Nup_fig <- ggplot( data = paper3_data , aes ( x = PI_N_Uptake , y = Index )) +
  geom_point( mapping = aes( x = PI_N_Uptake , 
                             y = Index , 
                             shape = year,
                             color = year) ,
              size = 4 ,
              data = paper3_data) +
  labs( x = "PI Total N Uptake ( kg N ha"^-1~")" , 
        y = "Index Value",  
        shape = "Year",
        color = "Year") +
  facet_grid(~Platform ) +
  theme_classic() +
  theme(axis.title = element_text(size = 30),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 26),
        legend.title = element_text(size = 26),
        #legend.position = "none",
        panel.spacing = unit(1.5, "lines"),
        panel.background = element_rect(fill = "white", color = "grey0"),
        strip.text.x = element_blank()) +
  coord_cartesian(ylim = c(0 , 1) , xlim = c(0, 260)) +
  scale_y_continuous(breaks = seq(0 , 1 , by = .1)) +
  scale_x_continuous(breaks = seq(0 , 250, by = 50)) +
  scale_shape_manual(values = c(0 , 1 , 2)) +
  geom_text( data = label_text ,
             mapping = aes( x = x_position ,
                            y = y_position , 
                            label = label) , 
             size = 9 ,
             parse = T)


Nup_fig


```

##models for gs ndvi

```{r}

gsndvi_df <- paper3_data %>% 
  filter(Platform == "GreenSeeker_NDVI") #filter just gs ndvi values

gs_ndvi_lm <- lm(Index ~ PI_N_Uptake, data = gsndvi_df) #linear model
summary(gs_ndvi_lm) #r2 = 0.64

gs_ndvi_sm <- segmented(gs_ndvi_lm , seg.Z = ~ PI_N_Uptake) #segmented model
summary(gs_ndvi_sm) #r2 = 0.81 , breakpoint = 84.827
gs_ndvi_bp <- 84.827 #assigns breakpoint to object
gs_ndvi_fit <- fitted(gs_ndvi_sm) #gets fitted values
gs_ndvi_sm_df <- data.frame(gsndvi_df$PI_N_Uptake , gs_ndvi_fit) #creates dataframe

PI_N_Uptake2 <- gsndvi_df$PI_N_Uptake^2
gs_ndvi_qm <- lm(Index ~ PI_N_Uptake + PI_N_Uptake2 , gsndvi_df) #quadratic model
summary(gs_ndvi_qm) #r2 = 0.80
Anova(gs_ndvi_qm , type = 3)



gs_ndvi_fit_qm <- fitted(gs_ndvi_qm) #gets fitted values from quad model
gs_ndvi_qm_df <- data.frame(gsndvi_df$PI_N_Uptake , gs_ndvi_fit_qm) #creates dataframe
gs_ndvi_qm_df <- gs_ndvi_qm_df %>% 
  mutate(Platform = "GreenSeeker_NDVI")

gs_ndvi_qm_r2 <- round(summary(gs_ndvi_qm)$adj.r.squared , digits = 2)
gs_ndvi_qm_a <- as.numeric(as.character(coef(gs_ndvi_qm)[3]))
gs_ndvi_qm_b <- as.numeric(as.character(coef(gs_ndvi_qm)[2]))
gs_ndvi_qm_c <- as.numeric(as.character(coef(gs_ndvi_qm)[1]))
gs_ndvi_qm_sym_x <- (-gs_ndvi_qm_b) / (2*gs_ndvi_qm_a)
gs_ndvi_qm_sym_y <- gs_ndvi_qm_a*(gs_ndvi_qm_sym_x^2) + gs_ndvi_qm_b*gs_ndvi_qm_sym_x + gs_ndvi_qm_c

gs_ndvi_qm_eqn <- paste("y == -0.000016*x^2 + 0.006* x + 0.24")

gs_ndvi_qm_r2
gs_ndvi_qm_sym_y
gs_ndvi_qm_sym_x
```

##models for drone ndvi

```{r}



sUASndvi_df <- paper3_data %>% 
  filter(Platform == "sUAS_NDVI") #filter just sUAS ndvi values

sUAS_ndvi_lm <- lm(Index ~ PI_N_Uptake, data = sUASndvi_df) #linear model
summary(sUAS_ndvi_lm) #r2 = 0.60
sUAS_ndvi_sm <- segmented(sUAS_ndvi_lm , seg.Z = ~ PI_N_Uptake) #segmented model
summary(sUAS_ndvi_sm) #r2 = 0.82 , breakpoint = 85.083
sUAS_ndvi_bp <- 85.083
sUAS_ndvi_fit <- fitted(sUAS_ndvi_sm) #gets fitted values
sUAS_ndvi_sm_df <- data.frame(sUASndvi_df$PI_N_Uptake , sUAS_ndvi_fit) #creates dataframe

PI_N_Uptake2 <- sUASndvi_df$PI_N_Uptake^2
sUAS_ndvi_qm <- lm(Index ~ PI_N_Uptake + PI_N_Uptake2 , sUASndvi_df) #quadratic model
summary(sUAS_ndvi_qm) #r2 = 0.78

sUAS_ndvi_fit_qm <- fitted(sUAS_ndvi_qm) #gets fitted values from quad model
sUAS_ndvi_qm_df <- data.frame(sUASndvi_df$PI_N_Uptake , sUAS_ndvi_fit_qm) #creates dataframe

sUAS_ndvi_qm_df <- sUAS_ndvi_qm_df %>% 
  mutate(Platform = "sUAS_NDVI")

#getting the equation for the plot
sUAS_ndvi_qm_r2 <- round(summary(sUAS_ndvi_qm)$adj.r.squared , digits = 2)
sUAS_ndvi_qm_a <- as.numeric(as.character(coef(sUAS_ndvi_qm)[3]))
sUAS_ndvi_qm_b <- as.numeric(as.character(coef(sUAS_ndvi_qm)[2]))
sUAS_ndvi_qm_c <- as.numeric(as.character(coef(sUAS_ndvi_qm)[1]))
sUAS_ndvi_qm_sym_x <- (-sUAS_ndvi_qm_b) / (2*sUAS_ndvi_qm_a)
sUAS_ndvi_qm_sym_y <- sUAS_ndvi_qm_a*(sUAS_ndvi_qm_sym_x^2) + sUAS_ndvi_qm_b*sUAS_ndvi_qm_sym_x + sUAS_ndvi_qm_c

sUAS_ndvi_qm_eqn <- paste("y == -0.0000088*x^2 + 0.0030* x + 0.69")

sUAS_ndvi_qm_r2
sUAS_ndvi_qm_sym_y
sUAS_ndvi_qm_sym_x
```

##models for drone ndre

```{r}


sUASndre_df <- paper3_data %>% 
  filter(Platform == "sUAS_NDRE") #filter just sUAS ndre values

sUAS_ndre_lm <- lm(Index ~ PI_N_Uptake, data = sUASndre_df) #linear model
summary(sUAS_ndre_lm) #r2 = 0.73

sUAS_ndre_sm <- segmented(sUAS_ndre_lm , seg.Z = ~ PI_N_Uptake) #segmented model
summary(sUAS_ndre_sm) #r2 = 0.79 , breakpoint = 91.056
sUAS_ndre_fit <- fitted(sUAS_ndre_sm) #gets fitted values
sUAS_ndre_sm_df <- data.frame(sUASndre_df$PI_N_Uptake , sUAS_ndre_fit) #creates dataframe

PI_N_Uptake2 <- sUASndre_df$PI_N_Uptake^2
sUAS_ndre_qm <- lm(Index ~ PI_N_Uptake + PI_N_Uptake2 , sUASndre_df) #quadratic model
summary(sUAS_ndre_qm) #r2 = 0.82

sUAS_ndre_qm_mse <- mean(residuals(sUAS_ndre_qm)^2)
sUAS_ndre_qm_mse

sUAS_ndre_qm_rmse <- sqrt(sUAS_ndre_qm_mse)
sUAS_ndre_qm_rmse


sUAS_ndre_fit_lm <- fitted(sUAS_ndre_lm) #gets fitted values from linear model
sUAS_ndre_lm_df <- data.frame(sUASndre_df$PI_N_Uptake , sUAS_ndre_fit_lm) #creates dataframe

sUAS_ndre_lm_df <- sUAS_ndre_lm_df %>% 
  mutate(Platform = "sUAS_NDRE")

sUAS_ndre_fit_qm <- fitted(sUAS_ndre_qm) #gets fitted values from linear model
sUAS_ndre_qm_df <- data.frame(sUASndre_df$PI_N_Uptake , sUAS_ndre_fit_qm) #creates dataframe

sUAS_ndre_qm_df <- sUAS_ndre_qm_df %>% 
  mutate(Platform = "sUAS_NDRE")
  

#getting the equation for the plot
sUAS_ndre_lm_r2 <- round(summary(sUAS_ndre_lm)$adj.r.squared , digits = 2)
sUAS_ndre_lm_b <- as.numeric(as.character(coef(sUAS_ndre_lm)[1]))
sUAS_ndre_lm_m <- as.numeric(as.character(coef(sUAS_ndre_lm)[2]))
#getting the equation for the plot
sUAS_ndre_qm_r2 <- round(summary(sUAS_ndre_qm)$adj.r.squared , digits = 2)
sUAS_ndre_qm_a <- as.numeric(as.character(coef(sUAS_ndre_qm)[3]))
sUAS_ndre_qm_b <- as.numeric(as.character(coef(sUAS_ndre_qm)[2]))
sUAS_ndre_qm_c <- as.numeric(as.character(coef(sUAS_ndre_qm)[1]))
sUAS_ndre_qm_sym_x <- (-sUAS_ndre_qm_b) / (2*sUAS_ndre_qm_a)
sUAS_ndre_qm_sym_y <- sUAS_ndre_qm_a*(sUAS_ndre_qm_sym_x^2) + sUAS_ndre_qm_b*sUAS_ndre_qm_sym_x + sUAS_ndre_qm_c

sUAS_ndre_qm_eqn <- paste("y == -1.1e-05*x^2 + 0.004* x + 0.27")

sUAS_ndre_qm_r2
sUAS_ndre_qm_sym_y
sUAS_ndre_qm_sym_x

sUAS_ndre_lm_eqn <- paste("y == 0.0022* x + 0.38")

sUAS_ndre_lm_r2
```

##linear model b/a bp

###gs ndvi
```{r}

#here, i'm going to remove data before the breakpoint for each segmented model (based on platform) , then develop a simple linear model for the separate linear segments and test for their significance

paper3_data_gs_b4_bp <- paper3_data %>% 
  filter(Platform == "GreenSeeker_NDVI" & PI_N_Uptake < gs_ndvi_bp) #gs ndvi data before breakpoint

paper3_data_gs_aft_bp <- paper3_data %>% 
  filter(Platform == "GreenSeeker_NDVI" & PI_N_Uptake >= gs_ndvi_bp) #gs ndvi data after breakpoint

gs_ndvi_lm_aft_bp <- lm ( Index ~ PI_N_Uptake , data = paper3_data_gs_aft_bp) #lm after breakpoint for gs ndvi
summary(gs_ndvi_lm_aft_bp)

ggplotRegression <- function (fit) {

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
} #this is a function I found online to quickly plot lm models and data. this is awesome!

ggplotRegression(gs_ndvi_lm_aft_bp) #plot the gs ndvi data and lm after the breakpoint



```

###uas ndvi

```{r}

paper3_data_uas_ndvi_b4_bp <- paper3_data %>% 
  filter(Platform == "sUAS_NDVI" & PI_N_Uptake < sUAS_ndvi_bp) #drone ndvi data before breakpoint

paper3_data_uas_ndvi_aft_bp <- paper3_data %>% 
  filter(Platform == "sUAS_NDVI" & PI_N_Uptake >= sUAS_ndvi_bp) #drone ndvi data after breakpoint

uas_ndvi_lm_aft_bp <- lm ( Index ~ PI_N_Uptake , data = paper3_data_uas_ndvi_aft_bp) #lm after breakpoint for drone ndvi
summary(uas_ndvi_lm_aft_bp)

ggplotRegression(uas_ndvi_lm_aft_bp) #plot the data and lm

#the segmented model for drone ndvi is significantly positive after the breakpoint as well. Analyzing the data in this way won't work. 

```


##PI Nup ~ Index Fig


```{r}

platform <- data.frame( 
  label = c("NDVI[GS]" ,
            "NDVI[UAS]",
            "NDRE[UAS]"
) ,
  Platform = c("GreenSeeker_NDVI" ,
               "sUAS_NDVI" ,
            "sUAS_NDRE"
            ),
  x_position = c(Inf , Inf , Inf ),
  x_just_var = c( 2.5 , 2.2 , 2) ,
  y_position = c(-Inf , -Inf , -Inf ),
  y_just_var = c(-12 , -12 , -12)
  )

equation <- data.frame( 
  label = c(gs_ndvi_qm_eqn,
            sUAS_ndvi_qm_eqn,
            sUAS_ndre_qm_eqn
            ) ,
  Platform = c("GreenSeeker_NDVI" ,
               "sUAS_NDVI" ,
            "sUAS_NDRE" 
            ),
  x_position = c(Inf , Inf , Inf ),
  x_just_var = c(1.05 , 1.05 , 1.05) ,
  y_position = c(-Inf , -Inf , -Inf ),
  y_just_var = c(-8 , -8 , -8)
  )

rsquared <- data.frame( 
  label = c("R^2 == '0.81'",
            "R^2 == '0.80'" ,
            "R^2 == '0.80'" 
            ) ,
  Platform = c("GreenSeeker_NDVI" ,
               "sUAS_NDVI",
            "sUAS_NDRE" 
            ),
  x_position = c(Inf , Inf , Inf ),
  x_just_var = c(2.25 , 2.25 , 2) ,
  y_position = c(-Inf , -Inf , -Inf ),
  y_just_var = c(-8.5 , -8.5 , -8.5)
  )

asymptote <- data.frame( 
  label = c("asym == 0.77",
            "asym == 0.94" ,
            "asym == 0.74" 
            ) ,
  Platform = c("GreenSeeker_NDVI" ,
               "sUAS_NDVI",
            "sUAS_NDRE" 
            ),
  x_position = c(Inf , Inf , Inf ),
  x_just_var = c(1.85 , 1.85 , 1.65) ,
  y_position = c(-Inf , -Inf , -Inf ),
  y_just_var = c(-7.75 , -7.75 , -7.75)
  )

platform$Platform = factor(platform$Platform, levels=c("GreenSeeker_NDVI" , "sUAS_NDVI" , "sUAS_NDRE"))
equation$Platform = factor(equation$Platform, levels=c("GreenSeeker_NDVI" , "sUAS_NDVI" , "sUAS_NDRE"))
rsquared$Platform = factor(rsquared$Platform, levels=c("GreenSeeker_NDVI" , "sUAS_NDVI" , "sUAS_NDRE"))
asymptote$Platform = factor(asymptote$Platform, levels=c("GreenSeeker_NDVI" , "sUAS_NDVI" , "sUAS_NDRE"))
gs_ndvi_qm_df$Platform = as.factor(gs_ndvi_qm_df$Platform)
sUAS_ndvi_qm_df$Platform = as.factor(sUAS_ndvi_qm_df$Platform)
sUAS_ndre_qm_df$Platform = as.factor(sUAS_ndre_qm_df$Platform)
asym_data_gs_ndvi <- data.frame(yint = gs_ndvi_qm_sym_y , Platform = factor("GreenSeeker_NDVI"))
asym_data_sUAS_ndvi <- data.frame(yint = sUAS_ndvi_qm_sym_y , Platform = factor("sUAS_NDVI"))
asym_data_sUAS_ndre <- data.frame(yint = sUAS_ndre_qm_sym_y , Platform = factor("sUAS_NDRE"))

Nup_fig_with_models <- Nup_fig +
  geom_line(data = gs_ndvi_qm_df , aes(x = gsndvi_df$PI_N_Uptake , y = gs_ndvi_fit_qm ) , size = 2 , color = "black") +
  geom_hline(data = asym_data_gs_ndvi , aes(yintercept = yint) , size = 1 , color = "black" , lty = 2.5) +
  geom_line(data = sUAS_ndvi_qm_df , aes(x = sUASndvi_df$PI_N_Uptake , y = sUAS_ndvi_fit_qm ),  size = 2  , color = "black") +
  geom_hline( data =  asym_data_sUAS_ndvi, aes(yintercept = yint ) , size = 1 , color = "black" , lty = 2.5) +
  geom_line(data = sUAS_ndre_qm_df , aes(x = sUASndre_df$PI_N_Uptake , y = sUAS_ndre_fit_qm ),  size = 2  , color = "black") +
  geom_hline( data =  asym_data_sUAS_ndre , aes(yintercept = yint ) , size = 1 , color = "black" , lty = 2.5) +
  geom_text( data = platform ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position , 
                            vjust = y_just_var , 
                            label = label) , 
             size = 7 ,
             parse = T) +
  geom_text( data = equation ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position , 
                            vjust = y_just_var , 
                            label = label) , 
             size = 7 ,
             parse = T) +
  geom_text( data = rsquared ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position , 
                            vjust = y_just_var , 
                            label = label) , 
             size = 7 ,
             parse = T) +
  geom_text( data = asymptote ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position , 
                            vjust = y_just_var , 
                            label = label) , 
             size = 7 ,
             parse = T)

Nup_fig_with_models

ggsave("FIGURES/Paper3_Fig_2.tiff" , Nup_fig_with_models , compression = "lzw" , width = 19 , height = 9.5, type = "cairo" , dpi = 500)

```

##Data for Yield Response Figure
```{r}


paper3_data_no_2018 <- paper3_data %>% 
  filter(year != "2018",
         !ID %in% c(419, 420 , 431 , 432 , 947 , 948 ,959 , 960 , 1475 , 1476 , 1487 , 1488))
#need to get the dataframe in the right form to make saturation figure for the paper. Removes 2018 year bc we don't use yield data from that year. Also removes outlier observations from Davis-19 site. 

paper3_data_0_gs <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot",    "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,     "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 0 , Platform == "GreenSeeker_NDVI" ) %>% 
  rename(TopDress_kgha_0 = TopDress_kgha,
         GrainYield_Mgha_0 = GrainYield_Mgha) #filters out 0 top-dress rate and greenseeker NDVI

paper3_data_25_gs <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot",  "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,     "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 25 , Platform == "GreenSeeker_NDVI" ) %>% 
  rename(TopDress_kgha_25 = TopDress_kgha,
         GrainYield_Mgha_25 = GrainYield_Mgha) #filters 25 td rate and gs ndvi

paper3_data_34_gs <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot",  "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 34 , Platform == "GreenSeeker_NDVI" ) %>% 
  rename(TopDress_kgha_34 = TopDress_kgha,
         GrainYield_Mgha_34 = GrainYield_Mgha) #filters 34 td and gs ndvi

paper3_data_50_gs <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 50 , Platform == "GreenSeeker_NDVI" ) %>% 
  rename(TopDress_kgha_50 = TopDress_kgha,
         GrainYield_Mgha_50 = GrainYield_Mgha) #50 td and gs ndvi

test_data1 <- full_join(paper3_data_0_gs , paper3_data_25_gs) #joins 0 and 25
test_data2 <- full_join(test_data1 , paper3_data_34_gs) #adds 34
test_data3 <- full_join(test_data2 , paper3_data_50_gs) #adds 50

#got the data right for greenseeker ndvi. Now gotta do it for the other two platforms

paper3_data_0_uas_NDVI <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 0 , Platform == "sUAS_NDVI" ) %>% 
  rename(TopDress_kgha_0 = TopDress_kgha,
         GrainYield_Mgha_0 = GrainYield_Mgha) #filters out 0 top-dress rate and sUAS NDVI

paper3_data_25_uas_NDVI <- paper3_data_no_2018 %>%
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 25 , Platform == "sUAS_NDVI" ) %>% 
  rename(TopDress_kgha_25 = TopDress_kgha,
         GrainYield_Mgha_25 = GrainYield_Mgha) #filters 25 td rate and sUAS ndvi

paper3_data_34_uas_NDVI <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 34 , Platform == "sUAS_NDVI" ) %>% 
  rename(TopDress_kgha_34 = TopDress_kgha,
         GrainYield_Mgha_34 = GrainYield_Mgha) #filters 34 td and sUAS ndvi

paper3_data_50_uas_NDVI <- paper3_data_no_2018 %>%
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 50 , Platform == "sUAS_NDVI" ) %>% 
  rename(TopDress_kgha_50 = TopDress_kgha,
         GrainYield_Mgha_50 = GrainYield_Mgha) #50 td and sUAS ndvi

test_data11 <- full_join(paper3_data_0_uas_NDVI , paper3_data_25_uas_NDVI) #joins 0 and 25
test_data22 <- full_join(test_data11 , paper3_data_34_uas_NDVI) #adds 34
test_data33 <- full_join(test_data22 , paper3_data_50_uas_NDVI) #adds 50

#i named them with double digits to differentiate from the test datas above

#now to repeat the steps one last time for suas_NDRE

paper3_data_0_uas_NDRE <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 0 , Platform == "sUAS_NDRE" ) %>% 
  rename(TopDress_kgha_0 = TopDress_kgha,
         GrainYield_Mgha_0 = GrainYield_Mgha) #filters out 0 top-dress rate and sUAS NDRE

paper3_data_25_uas_NDRE <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 25 , Platform == "sUAS_NDRE" ) %>% 
  rename(TopDress_kgha_25 = TopDress_kgha,
         GrainYield_Mgha_25 = GrainYield_Mgha) #filters 25 td rate and sUAS NDRE

paper3_data_34_uas_NDRE <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 34 , Platform == "sUAS_NDRE" ) %>% 
  rename(TopDress_kgha_34 = TopDress_kgha,
         GrainYield_Mgha_34 = GrainYield_Mgha) #filters 34 td and sUAS NDRE

paper3_data_50_uas_NDRE <- paper3_data_no_2018 %>% 
  select("site_year" , "year" , "Platform" , "exp_plot_number", "Block" , "MainPlot", "N_level_kgha"  , "N_level_kgha_f" , "TopDress_kgha"  ,      "RI","GrainYield_Mgha" ) %>% 
  filter(TopDress_kgha == 50 , Platform == "sUAS_NDRE" ) %>% 
  rename(TopDress_kgha_50 = TopDress_kgha,
         GrainYield_Mgha_50 = GrainYield_Mgha) #50 td and sUAS NDRE

test_data111 <- full_join(paper3_data_0_uas_NDRE , paper3_data_25_uas_NDRE) #joins 0 and 25
test_data222 <- full_join(test_data111 , paper3_data_34_uas_NDRE) #adds 34
test_data333 <- full_join(test_data222 , paper3_data_50_uas_NDRE) #adds 50

#I have the mean NDVI/NDRE RI for each platform and the mean yield at each top-dress rate. I need to combine them all, get the mean response and then plot it all on a double y axis plot. I can do a bar chart or I can do all points. 

sat_fig_data <- rbind(test_data3 , test_data33 , test_data333) #binds the three df's 

#here I am going to need to select out sites with 25 & 50 td rate and 34 td rate separately, calculate the yield response, and then bind them. 

sat_fig_data <- sat_fig_data %>% 
  as.data.frame() %>% 
  mutate(Yield_Response_Mgha_25 = GrainYield_Mgha_25 - GrainYield_Mgha_0 ,
         Yield_Response_Mgha_34 = GrainYield_Mgha_34 - GrainYield_Mgha_0 ,
         Yield_Response_Mgha_50 = GrainYield_Mgha_50 - GrainYield_Mgha_0) #calculates the GrainYield response for each top-dress rate. for some reason it was giving me an error so I added the as.data.frame line

sat_fig_data <- sat_fig_data %>% 
  mutate(Yield_Response_Mgha = (Yield_Response_Mgha_25 + Yield_Response_Mgha_50) / 2) #calculate mean yield response across 25 and 50 rate

sat_fig_data_1 <- sat_fig_data %>% 
  filter(site_year %in% c("Nicolaus-17" , "Williams-17")) %>% 
  select(site_year , N_level_kgha , Platform , RI , Yield_Response_Mgha) #filters 2017 sites and selects relevant columns

sat_fig_data_2 <- sat_fig_data %>% 
  filter(!site_year %in% c("Nicolaus-17" , "Williams-17")) %>% 
  select(site_year , N_level_kgha , Platform , RI , Yield_Response_Mgha_34) %>% 
  rename(Yield_Response_Mgha = Yield_Response_Mgha_34) #filters 2019 data and selects relevant columns

sat_fig_data <- rbind(sat_fig_data_1 , sat_fig_data_2) #rinds the two df's with the relevant data needed for the figure

sat_fig_data <- sat_fig_data %>% 
  mutate(RI_adj = RI - 1) #removes 1 from RI to make the scales work for dual axis plot, also adds response column for the bar chart legend.

sat_fig_data <- sat_fig_data %>% 
  group_by(site_year , N_level_kgha , Platform) %>% 
  summarise(Mean_Yield_Response_Mgha = mean(Yield_Response_Mgha),
            Yield_Response_Mgha_sd = sd(Yield_Response_Mgha),
            Mean_RI = mean(RI),
            Mean_RI_adj = mean(RI_adj)) %>% 
  ungroup()

sat_fig_data <- sat_fig_data %>% 
  mutate(Response = "Grain Yield Response")

sat_fig_data$Response <- as.factor(sat_fig_data$Response) #changes response to factor

factor_list <- list(sat_fig_data$Platform , sites = sat_fig_data$site_year)

round(tapply(sat_fig_data$Mean_RI , factor_list , min) , digits = 2)
round(tapply(sat_fig_data$Mean_RI , factor_list , max) , digits = 2)

```

##Yield Response Figure
```{r}

sat_fig_data$site_year <- factor(sat_fig_data$site_year , levels = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19"))

sites <- data.frame( 
  label = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19" ) ,
  site_year = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19"),
  x_position = c(Inf , Inf , Inf , Inf , Inf , Inf ),
  x_just_var = c(1.25 , 1.25 , 1.25 , 1.25 , 1.25 , 1.25  ) ,
  y_position = c(3 , 3 , 3 , 3, 3 , 3 )
  )

sites$label <- factor(sites$label)
sites$site_year <- factor(sites$label)

# Dual axis facet_wrap plot

yield_resp_figure_1 <- ggplot(sat_fig_data , aes(x = N_level_kgha ,
                                               y = Mean_Yield_Response_Mgha)) +
  geom_col(filter(sat_fig_data , Platform == "GreenSeeker_NDVI") , 
           mapping = aes(x = N_level_kgha ,
                y = Mean_Yield_Response_Mgha ,
                fill = Response), width = 25) +
  geom_errorbar(aes(ymin = Mean_Yield_Response_Mgha - Yield_Response_Mgha_sd,
                    ymax = Mean_Yield_Response_Mgha + Yield_Response_Mgha_sd), width=.2,
                 position = position_dodge(.9))  +
  geom_line(data = sat_fig_data  , aes(x = N_level_kgha ,
                                               y = Mean_RI_adj ,
                                       linetype = Platform) , size = 1.5) +
  labs( x = "Pre-plant N Rate ( kg N ha"^-1~")" , y = "Mean Yield Response to Top-dress N ( Mg ha"^-1~")" , linetype = NULL , fill = NULL) +
  scale_y_continuous(sec.axis = sec_axis(~ . + 1 , name = "Mean Response-Index")) +
  facet_wrap(~site_year) +
  geom_hline( yintercept = 0 , size = .5) +
  scale_linetype_manual(breaks = c("GreenSeeker_NDVI" , "sUAS_NDRE" , "sUAS_NDVI") , labels = c("GreenSeeker NDVI RI" , "UAS NDRE RI" , "UAS NDVI RI"), values = c("solid", "dashed" , "dotted")) +
  guides(linetype = guide_legend(keywidth = 4 , keyheight = 2.3 , unit = "cm" , override.aes = list(size = 2))) +
  theme_classic() +
  theme(axis.title = element_text(size = 30)) +
  theme(axis.text = element_text(size = 26)) +
  theme(legend.text = element_text(size = 26)) +
  theme(legend.title = element_text(size = 26)) +
  theme(strip.text.x = element_blank()) +
  theme(panel.spacing = unit(1.5, "lines")) +
  theme(legend.position = "bottom") +
  geom_text( data = sites ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position , 
                            label = label) , 
             size = 8 ,
             parse = T)

yield_resp_figure_1

ggsave("FIGURES/NOT_IN_PUBLICATION/Paper3_Fig_3_with_errorbar.tiff" , yield_resp_figure_1 , compression = "lzw" , width = 18 , height = 13, type = "cairo" , dpi = 750)

```

```{r}

sat_fig_data$site_year <- factor(sat_fig_data$site_year , levels = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19"))

sites <- data.frame( 
  label = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19" ) ,
  site_year = c("Nicolaus-17" ,
            "Williams-17" ,
            "Arbuckle-19" ,
            "Davis-19" ,
            "Marysville-19" ,
            "RES-19"),
  x_position = c(Inf , Inf , Inf , Inf , Inf , Inf ),
  x_just_var = c(1.25 , 1.25 , 1.25 , 1.25 , 1.25 , 1.25  ) ,
  y_position = c(2.5 , 2.5 , 2.5 , 2.5 , 2.5 , 2.5 )
  )

yield_resp_figure_2 <- ggplot(sat_fig_data , aes(x = N_level_kgha ,
                                               y = Mean_Yield_Response_Mgha)) +
  geom_col(filter(sat_fig_data , Platform == "GreenSeeker_NDVI") , 
           mapping = aes(x = N_level_kgha ,
                y = Mean_Yield_Response_Mgha ,
                fill = Response), width = 25) +
  geom_line(data = sat_fig_data  , aes(x = N_level_kgha ,
                                               y = Mean_RI_adj ,
                                       linetype = Platform) , size = 1.25) +
  labs( x = "Pre-plant N Rate ( kg N ha"^-1~")" , y = "Mean Yield Response to Top-dress N ( Mg ha"^-1~")" , linetype = "Response-Index" , fill = NULL) +
  scale_y_continuous(sec.axis = sec_axis(~ . + 1 , name = "Mean Response-Index")) +
  facet_wrap(~site_year) +
  geom_hline( yintercept = 0 , size = .5) +
  theme_classic() +
  theme(axis.title = element_text(size = 28)) +
  theme(axis.text = element_text(size = 24)) +
  theme(legend.text = element_text(size = 24)) +
  theme(legend.title = element_text(size = 24)) +
  theme(strip.text.x = element_blank()) +
  theme(panel.spacing = unit(1.5, "lines")) +
  geom_text( data = sites ,
             mapping = aes( x = x_position ,
                            hjust = x_just_var , 
                            y = y_position ,
                            label = label) , 
             size = 8 ,
             parse = T)

yield_resp_figure_2

ggsave("FIGURES/NOT_IN_PUBLICATION/Paper3_Fig_3_without_errorbar.tiff" , yield_resp_figure_2 , compression = "lzw" , width = 18 , height = 10, type = "cairo" , dpi = 750)

```


##RI ~ Rel GY Figure
```{r}

greenseeker_ndvi_data <- paper3_data_no_2018 %>% 
  filter(Platform == "GreenSeeker_NDVI")

greenseeker_ndvi_data2 <- greenseeker_ndvi_data %>% 
  filter(TopDress_kgha == 0)

nic17 <- subset(greenseeker_ndvi_data2, site_year == "Nicolaus-17")
nic17 <- apply(nic17,2,max)
nic17max_yield <- as.numeric(nic17[17])

wil17 <- subset(greenseeker_ndvi_data2, site_year == "Williams-17")
wil17 <- apply(wil17,2,max)
wil17max_yield <- as.numeric(wil17[17])

arb19 <- subset(greenseeker_ndvi_data2, site_year == "Arbuckle-19")
arb19 <- apply(arb19,2,max)
arb19max_yield <- as.numeric(arb19[17])

dav19 <- subset(greenseeker_ndvi_data2, site_year == "Davis-19")
dav19 <- apply(dav19,2,max)
dav19max_yield <- as.numeric(dav19[17])

mry19 <- subset(greenseeker_ndvi_data2, site_year == "Marysville-19")
mry19 <- apply(mry19,2,max)
mry19max_yield <- as.numeric(mry19[17])

res19 <- subset(greenseeker_ndvi_data2, site_year == "RES-19")
res19 <- apply(res19,2,max)
res19max_yield <- as.numeric(res19[17])


greenseeker_ndvi_data2 <- greenseeker_ndvi_data2 %>% 
  mutate(relative_grain_yield = case_when(
                          site_year == "Nicolaus-17" ~ GrainYield_Mgha / nic17max_yield ,
                          site_year == "Williams-17" ~ GrainYield_Mgha / wil17max_yield ,
                          site_year == "Arbuckle-19" ~ GrainYield_Mgha / arb19max_yield ,
                          site_year == "Davis-19" ~ GrainYield_Mgha / dav19max_yield ,
                          site_year == "Marysville-19" ~ GrainYield_Mgha / mry19max_yield ,
                          site_year == "RES-19" ~ GrainYield_Mgha / res19max_yield))

greenseeker_ndvi_rel_gy_plot2 <- ggplot(data = greenseeker_ndvi_data2 , aes (  x = RI , y = relative_grain_yield )) +
  geom_point(mapping = aes( x = RI , y = relative_grain_yield))

greenseeker_ndvi_rel_gy_plot2

greenseeker_ndvi_rel_gy_model2 <- lm(relative_grain_yield ~ RI  , data = greenseeker_ndvi_data2)

summary(greenseeker_ndvi_rel_gy_model2)
plot(greenseeker_ndvi_rel_gy_model2)

gs_ndvi_rel_gy_fit2 <- fitted(greenseeker_ndvi_rel_gy_model2) #gets fitted values
gs_ndvi_rel_gy_df2 <- data.frame(greenseeker_ndvi_data2$RI , gs_ndvi_rel_gy_fit2) #creates dataframe

greenseeker_ndvi_rel_gy_plot2 <- greenseeker_ndvi_rel_gy_plot2 +
  geom_line(data = gs_ndvi_rel_gy_df2 , aes(x = greenseeker_ndvi_data2$RI , y = gs_ndvi_rel_gy_fit2 ) , size = 1 , color = "black")

greenseeker_ndvi_rel_gy_plot2

sUAS_ndvi_data <- paper3_data_no_2018 %>% 
  filter(Platform == "sUAS_NDVI")

sUAS_ndvi_data2 <- sUAS_ndvi_data %>% 
  filter(TopDress_kgha == 0)

nic17 <- subset(sUAS_ndvi_data2, site_year == "Nicolaus-17")
nic17 <- apply(nic17,2,max)
nic17max_yield <- as.numeric(nic17[17])

wil17 <- subset(sUAS_ndvi_data2, site_year == "Williams-17")
wil17 <- apply(wil17,2,max)
wil17max_yield <- as.numeric(wil17[17])

arb19 <- subset(sUAS_ndvi_data2, site_year == "Arbuckle-19")
arb19 <- apply(arb19,2,max)
arb19max_yield <- as.numeric(arb19[17])

dav19 <- subset(sUAS_ndvi_data2, site_year == "Davis-19")
dav19 <- apply(dav19,2,max)
dav19max_yield <- as.numeric(dav19[17])

mry19 <- subset(sUAS_ndvi_data2, site_year == "Marysville-19")
mry19 <- apply(mry19,2,max)
mry19max_yield <- as.numeric(mry19[17])

res19 <- subset(sUAS_ndvi_data2, site_year == "RES-19")
res19 <- apply(res19,2,max)
res19max_yield <- as.numeric(res19[17])


sUAS_ndvi_data2 <- sUAS_ndvi_data2 %>% 
  mutate(relative_grain_yield = case_when(
                          site_year == "Nicolaus-17" ~ GrainYield_Mgha / nic17max_yield ,
                          site_year == "Williams-17" ~ GrainYield_Mgha / wil17max_yield ,
                          site_year == "Arbuckle-19" ~ GrainYield_Mgha / arb19max_yield ,
                          site_year == "Davis-19" ~ GrainYield_Mgha / dav19max_yield ,
                          site_year == "Marysville-19" ~ GrainYield_Mgha / mry19max_yield ,
                          site_year == "RES-19" ~ GrainYield_Mgha / res19max_yield))

suas_ndvi_rel_gy_plot2 <- ggplot(data = sUAS_ndvi_data2 , aes ( x = RI , y = relative_grain_yield )) +
  geom_point(mapping = aes( x = RI , y = relative_grain_yield ))

suas_ndvi_rel_gy_plot2

suas_ndvi_rel_gy_model2 <- lm(relative_grain_yield ~ RI  , data = sUAS_ndvi_data2)

summary(suas_ndvi_rel_gy_model2)
plot(suas_ndvi_rel_gy_model2)

sUAS_ndvi_rel_gy_fit2 <- fitted(suas_ndvi_rel_gy_model2) #gets fitted values
sUAS_ndvi_rel_gy_df2 <- data.frame(sUAS_ndvi_data2$RI , sUAS_ndvi_rel_gy_fit2) #creates dataframe

suas_ndvi_rel_gy_plot2 <- suas_ndvi_rel_gy_plot2 +
  geom_line(data = sUAS_ndvi_rel_gy_df2 , aes(x = sUAS_ndvi_data2$RI , y = sUAS_ndvi_rel_gy_fit2 ) , size = 1 , color = "black")

suas_ndvi_rel_gy_plot2

sUAS_ndre_data <- paper3_data_no_2018 %>% 
  filter(Platform == "sUAS_NDRE")

sUAS_ndre_data2 <- sUAS_ndre_data %>% 
  filter(TopDress_kgha == 0)

nic17 <- subset(sUAS_ndre_data2, site_year == "Nicolaus-17")
nic17 <- apply(nic17,2,max)
nic17max_yield <- as.numeric(nic17[17])

wil17 <- subset(sUAS_ndre_data2, site_year == "Williams-17")
wil17 <- apply(wil17,2,max)
wil17max_yield <- as.numeric(wil17[17])

arb19 <- subset(sUAS_ndre_data2, site_year == "Arbuckle-19")
arb19 <- apply(arb19,2,max)
arb19max_yield <- as.numeric(arb19[17])

dav19 <- subset(sUAS_ndre_data2, site_year == "Davis-19")
dav19 <- apply(dav19,2,max)
dav19max_yield <- as.numeric(dav19[17])

mry19 <- subset(sUAS_ndre_data2, site_year == "Marysville-19")
mry19 <- apply(mry19,2,max)
mry19max_yield <- as.numeric(mry19[17])

res19 <- subset(sUAS_ndre_data2, site_year == "RES-19")
res19 <- apply(res19,2,max)
res19max_yield <- as.numeric(res19[17])


sUAS_ndre_data2 <- sUAS_ndre_data2 %>% 
  mutate(relative_grain_yield = case_when(
                          site_year == "Nicolaus-17" ~ GrainYield_Mgha / nic17max_yield ,
                          site_year == "Williams-17" ~ GrainYield_Mgha / wil17max_yield ,
                          site_year == "Arbuckle-19" ~ GrainYield_Mgha / arb19max_yield ,
                          site_year == "Davis-19" ~ GrainYield_Mgha / dav19max_yield ,
                          site_year == "Marysville-19" ~ GrainYield_Mgha / mry19max_yield ,
                          site_year == "RES-19" ~ GrainYield_Mgha / res19max_yield))

suas_ndre_rel_gy_plot2 <- ggplot(data = sUAS_ndre_data2 , aes ( x = RI , y = relative_grain_yield)) +
  geom_point(mapping = aes(x = RI , y = relative_grain_yield))

suas_ndre_rel_gy_plot2

suas_ndre_rel_gy_model2 <- lm( relative_grain_yield ~ RI , data = sUAS_ndre_data2)

summary(suas_ndre_rel_gy_model2)
plot(suas_ndre_rel_gy_model2)

sUAS_ndre_rel_gy_fit2 <- fitted(suas_ndre_rel_gy_model2) #gets fitted values
sUAS_ndre_rel_gy_df2 <- data.frame(sUAS_ndre_data2$relative_grain_yield , sUAS_ndre_rel_gy_fit2) #creates dataframe

suas_ndre_rel_gy_plot2 <- suas_ndre_rel_gy_plot2 +
  geom_line(data = sUAS_ndre_rel_gy_df2 , aes( x =  sUAS_ndre_data2$RI , y = sUAS_ndre_rel_gy_fit2) , size = 1 , color = "black")

suas_ndre_rel_gy_plot2

greenseeker_ndvi_data2 <- greenseeker_ndvi_data2 %>% 
  mutate(Platform = "GreenSeeker_NDVI")

sUAS_ndvi_data2 <- sUAS_ndvi_data2 %>% 
  mutate(Platform = "sUAS_NDVI")

sUAS_ndre_data2 <- sUAS_ndre_data2 %>% 
  mutate(Platform = "sUAS_NDRE")

relative_yield_data <- rbind(greenseeker_ndvi_data2, sUAS_ndvi_data2 , sUAS_ndre_data2 )

relative_yield_data2 <- relative_yield_data %>% 
  select(Platform , N_level_kgha_f , RI , relative_grain_yield) %>% 
  group_by(Platform , N_level_kgha_f) %>% 
  summarise(mean_RI = mean(RI) , mean_rel_gy = mean(relative_grain_yield)) %>% 
  ungroup()

```

```{r }

rel_gy_plot <- ggplot(data = relative_yield_data2 , aes ( x = mean_RI , y = mean_rel_gy )) +
  geom_point(mapping = aes(x = mean_RI , y = mean_rel_gy , color = Platform , shape = Platform) , size = 4) +
 geom_line(data = gs_ndvi_rel_gy_df2 , aes(x = sUAS_ndre_data2$RI , y = sUAS_ndre_rel_gy_fit2 ) , size = 2 , color = "black") +
 geom_line(data = gs_ndvi_qm_df , aes(x = gsndvi_df$PI_N_Uptake , y = gs_ndvi_fit_qm ) , size = 2 , color = "black") +
  geom_line(data = gs_ndvi_qm_df , aes(x = gsndvi_df$PI_N_Uptake , y = gs_ndvi_fit_qm ) , size = 2 , color = "black") +
  theme_classic() +
  labs( x =  "Response Index Value" , 
        y = "Relative Grain Yield",  
        shape = "Platform",
        color = "Plaform") +
  theme(axis.title = element_text(size = 30),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 26),
        legend.title = element_text(size = 26),
        legend.position = "none",
        panel.spacing = unit(1, "lines"),
        panel.background = element_rect(fill = "white", color = "grey0"),
        strip.text.x = element_blank()) +
  coord_cartesian(ylim = c(0.29, 1) , xlim = c(1 , 4)) +
  scale_x_continuous(breaks = seq(0 , 4 , by = .5)) +
  scale_y_continuous(breaks = seq(0.3 , 1, by = .1)) +
  scale_shape_manual(values = c(0 , 1 , 2))

rel_gy_plot

rel_gy_plot2 <- ggplot(data = relative_yield_data , 
                       aes ( y = RI , 
                             x = relative_grain_yield )) +
  geom_point(mapping = aes(y = RI , 
                           x = relative_grain_yield , 
                           color = Platform , 
                           shape = Platform) , 
             size = 4) +
 geom_line(data = gs_ndvi_rel_gy_df , 
           aes(x = greenseeker_ndvi_data2.relative_grain_yield, 
               y = gs_ndvi_rel_gy_fit ) , 
           size = 1 ) +
 geom_line(data = sUAS_ndvi_rel_gy_df , aes(x = sUAS_ndvi_data2.relative_grain_yield ,
                                            y = sUAS_ndvi_rel_gy_fit ) , 
           size = 1 ) +
  geom_line(data = sUAS_ndre_rel_gy_df , 
            aes(x = sUAS_ndre_data2.relative_grain_yield , 
                y = sUAS_ndre_rel_gy_fit ) , 
            size = 1 ) +
  theme_classic() +
  labs( y =  "Response Index Value" , 
        x = "Relative Grain Yield",  
        shape = "Platform",
        color = "Plaform") +
  theme(axis.title = element_text(size = 30),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 26),
        legend.title = element_text(size = 26),
        legend.position = "none",
        panel.spacing = unit(1, "lines"),
        panel.background = element_rect(fill = "white", color = "grey0"),
        strip.text.x = element_blank()) +
  coord_cartesian(xlim = c(0.29, 1) , ylim = c(1 , 4)) +
  scale_y_continuous(breaks = seq(0 , 4 , by = .5)) +
  scale_x_continuous(breaks = seq(0.3 , 1, by = .1)) +
  scale_shape_manual(values = c(0 , 1 , 2))

rel_gy_plot2

#ggsave("FIGURES/Paper3_relative_yield.tiff" , rel_gy_plot , compression = "lzw" , width = 18 , height = 9 , type = "cairo" , dpi = 750)


```

#MODEL

##GS NDVI

```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

gs_ndvi_model <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = greenseeker_ndvi_data)

summary(gs_ndvi_model)

summary(gs_ndvi_model)$tTable

Anova(gs_ndvi_model , type = 3)

r.squaredGLMM(gs_ndvi_model)

```

## model diagnostics

```{r}

plot (gs_ndvi_model)

plot(resid(gs_ndvi_model, type = "normalized") ~fitted(gs_ndvi_model))

gs_ndvi_model_y <- resid(gs_ndvi_model, type = "normalized")
gs_ndvi_model_x <- fitted(gs_ndvi_model)

gs_ndvi_modelresid_data <- data.frame(gs_ndvi_model_x , gs_ndvi_model_y)

ggplot( data = gs_ndvi_modelresid_data , aes( x = gs_ndvi_model_x , y = gs_ndvi_model_y)) +
  geom_point(mapping = aes(gs_ndvi_model_x , gs_ndvi_model_y) , data = gs_ndvi_modelresid_data)

hist(resid(gs_ndvi_model))


plot(gs_ndvi_model, site_year ~ resid(.), abline = 0)


qqnorm(gs_ndvi_model, abline = c(0,1) )


qqnorm(resid(gs_ndvi_model))
qqline(resid(gs_ndvi_model))


qqnorm(gs_ndvi_model , ~resid(.) | site_year)

plot(ranef(gs_ndvi_model))

pairs(gs_ndvi_model , id = 0.1) 

qqnorm(gs_ndvi_model , ~ranef(.))

plot( gs_ndvi_model, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

##outlier removal 

```{r}

greenseeker_ndvi_data_OR <- greenseeker_ndvi_data[-(c(which(abs(residuals(gs_ndvi_model,type="normalized"))>qnorm(0.999)))),]

```

##rerun model sans outliers
```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

gs_ndvi_model_OR <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = greenseeker_ndvi_data_OR)

summary(gs_ndvi_model_OR)

summary(gs_ndvi_model_OR)$tTable

Anova(gs_ndvi_model_OR , type = 3)

r.squaredGLMM(gs_ndvi_model_OR)

gs_ndvi_r_sq <- r.squaredGLMM(gs_ndvi_model_OR)

gs_ndvi_r_sq_fixed <- round(gs_ndvi_r_sq[1] , digits = 2)
gs_ndvi_r_sq_fixed

gs_ndvi_r_sq_total <- round(gs_ndvi_r_sq[2] , digits = 2)
gs_ndvi_r_sq_total

gs_ndvi_r_sq_random <- gs_ndvi_r_sq_total - gs_ndvi_r_sq_fixed
gs_ndvi_r_sq_random


```

## model diagnostics

```{r}

plot (gs_ndvi_model_OR)

plot(resid(gs_ndvi_model_OR, type = "normalized") ~fitted(gs_ndvi_model_OR))

gs_ndvi_model_OR_y <- resid(gs_ndvi_model_OR, type = "normalized")
gs_ndvi_model_OR_x <- fitted(gs_ndvi_model_OR)

gs_ndvi_model_ORresid_data <- data.frame(gs_ndvi_model_OR_x , gs_ndvi_model_OR_y)

ggplot( data = gs_ndvi_model_ORresid_data , aes( x = gs_ndvi_model_OR_x , y = gs_ndvi_model_OR_y)) +
  geom_point(mapping = aes(gs_ndvi_model_OR_x , gs_ndvi_model_OR_y) , data = gs_ndvi_model_ORresid_data)

hist(resid(gs_ndvi_model_OR))


plot(gs_ndvi_model_OR, site_year ~ resid(.), abline = 0)


qqnorm(gs_ndvi_model_OR, abline = c(0,1) )


qqnorm(resid(gs_ndvi_model_OR))
qqline(resid(gs_ndvi_model_OR))


qqnorm(gs_ndvi_model_OR , ~resid(.) | site_year)

plot(ranef(gs_ndvi_model_OR))

pairs(gs_ndvi_model_OR , id = 0.1)

qqnorm(gs_ndvi_model_OR , ~ranef(.))

plot( gs_ndvi_model_OR, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```


##emmeans

```{r}

mylist <- list(SI=seq(0.25 , 1 , by = .0005),TopDress_kgha =c( 34 , 0))

gs_ndvi_emmeans <- emmeans(gs_ndvi_model_OR , ~TopDress_kgha * SI , at = mylist )

gs_ndvi_emmeans_contrast <- as.data.frame(summary(contrast(gs_ndvi_emmeans , "pairwise" , side = ">" , by = "SI"))[1:7])

gs_ndvi_emmeans_contrast <- gs_ndvi_emmeans_contrast %>% 
  mutate(GS_NDVI_Response_Index = 1 / SI )

gs_ndvi_emmeans_contrast <- gs_ndvi_emmeans_contrast %>% 
  mutate(prob_postive_resp = (1 - p.value) * 100)

gs_ndvi_emmeans_contrast <- gs_ndvi_emmeans_contrast %>% 
  mutate(t_score = abs((estimate - 0.26)) / SE)

gs_ndvi_emmeans_contrast <- gs_ndvi_emmeans_contrast %>% 
  mutate(prob = if_else(estimate < 0.26 , pt(q = t_score , df = df , lower.tail = F) , pt(q = t_score , df = df , lower.tail = T)))

gs_ndvi_emmeans_contrast$prob_percent <- (round(gs_ndvi_emmeans_contrast$prob , digits = 3) * 100)

gs_ndvi_emmeans_contrast$GS_NDVI_Response_Index_r <- round(gs_ndvi_emmeans_contrast$GS_NDVI_Response_Index , digits = 3)

gs_ndvi_run1 <- 125 - 100
gs_ndvi_rise1 <- 0.6404977 - 0.09953884
gs_ndvi_slope1 <- round((gs_ndvi_rise1 / gs_ndvi_run1) * 5 , digits = 2)
gs_ndvi_slope1

gs_ndvi_run2 <- 250 - 125
gs_ndvi_rise2 <- 1.722415 - 0.6404977 
gs_ndvi_slope2 <- round((gs_ndvi_rise2 / gs_ndvi_run2) * 5 , digits = 3)
gs_ndvi_slope2

gs_ndvi_run3 <- 400 - 250
gs_ndvi_rise3 <- 2.128135 - 1.722415
gs_ndvi_slope3 <- round((gs_ndvi_rise3 / gs_ndvi_run3) * 5 , digits = 3)
gs_ndvi_slope3

gs_ndvi_mean_se <- gs_ndvi_emmeans_contrast %>% 
  select(SE) %>% 
  summarise(mean_se = mean(SE))

gs_ndvi_mean_se$mean_se <- round(gs_ndvi_mean_se$mean_se , digits = 2)

gs_ndvi_mean_se$mean_se

```

##confidence interval

```{r}

#at every 0.10 interval, what is the 90% confidence interval of the yield response, and what RI value does that range correspond with?

str(gs_ndvi_emmeans_contrast , give.attr = F)

gs_ndvi_emmeans_contrast <- gs_ndvi_emmeans_contrast %>% 
  mutate(response_mgha_r = round(estimate , digits = 2),
         se_mgha_r = round(SE , digits = 3))

z_score <- 1.645

#estimate = 0.10 , SE = 0.120

print(round(0.10 - z_score*0.120 , digits = 2))
print(round(0.10 + z_score*0.120 , digits = 2))

#estimate = 0.20 , SE = 0.112

print(round(0.20 - z_score*0.112 , digits = 2))
print(round(0.20 + z_score*0.112 , digits = 2))


#estimate = 0.30 , SE = 0.106

print(round(0.30 - z_score*0.106 , digits = 2)) 
print(round(0.30 + z_score*0.106 , digits = 2))


#estimate = 0.40 , SE = 0.102

print(round(0.40 - z_score*0.102 , digits = 2)) 
print(round(0.40 + z_score*0.102 , digits = 2))

#estimate = 0.50 , SE = 0.102

print(round(0.50 - z_score*0.102 , digits = 2)) 
print(round(0.50 + z_score*0.102 , digits = 2))
```

##sUAS NDVI


```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

sUAS_ndvi_model <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = sUAS_ndvi_data)

summary(sUAS_ndvi_model)

summary(sUAS_ndvi_model)$tTable

Anova(sUAS_ndvi_model , type = 3)

r.squaredGLMM(sUAS_ndvi_model)

```

## model diagnostics

```{r}

plot (sUAS_ndvi_model)

plot(resid(sUAS_ndvi_model, type = "normalized") ~fitted(sUAS_ndvi_model))

sUAS_ndvi_model_y <- resid(sUAS_ndvi_model, type = "normalized")
sUAS_ndvi_model_x <- fitted(sUAS_ndvi_model)

sUAS_ndvi_modelresid_data <- data.frame(sUAS_ndvi_model_x , sUAS_ndvi_model_y)

ggplot( data = sUAS_ndvi_modelresid_data , aes( x = sUAS_ndvi_model_x , y = sUAS_ndvi_model_y)) +
  geom_point(mapping = aes(sUAS_ndvi_model_x , sUAS_ndvi_model_y) , data = sUAS_ndvi_modelresid_data)

hist(resid(sUAS_ndvi_model))


plot(sUAS_ndvi_model, site_year ~ resid(.), abline = 0)


qqnorm(sUAS_ndvi_model, abline = c(0,1) )


qqnorm(resid(sUAS_ndvi_model))
qqline(resid(sUAS_ndvi_model))


qqnorm(sUAS_ndvi_model , ~resid(.) | site_year)

plot(ranef(sUAS_ndvi_model))

pairs(sUAS_ndvi_model , id = 0.1) 

qqnorm(sUAS_ndvi_model , ~ranef(.))

plot( sUAS_ndvi_model, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

##outlier removal 

```{r}

sUAS_ndvi_data_OR <- sUAS_ndvi_data[-(c(which(abs(residuals(sUAS_ndvi_model,type="normalized"))>qnorm(0.999)))),] 

```

##rerun model sans outliers
```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

sUAS_ndvi_model_OR <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = sUAS_ndvi_data)

summary(sUAS_ndvi_model_OR)

summary(sUAS_ndvi_model_OR)$tTable

Anova(sUAS_ndvi_model_OR , type = 3)

r.squaredGLMM(sUAS_ndvi_model_OR)

ndvi_r_sq <- r.squaredGLMM(sUAS_ndvi_model_OR)

ndvi_r_sq_fixed <- round(ndvi_r_sq[1] , digits = 2)
ndvi_r_sq_fixed

ndvi_r_sq_total <- round(ndvi_r_sq[2] , digits = 2)
ndvi_r_sq_total

ndvi_r_sq_random <- ndvi_r_sq_total - ndvi_r_sq_fixed
ndvi_r_sq_random
```

## model diagnostics

```{r}

plot (sUAS_ndvi_model_OR)

plot(resid(sUAS_ndvi_model_OR, type = "normalized") ~fitted(sUAS_ndvi_model_OR))

sUAS_ndvi_model_OR_y <- resid(sUAS_ndvi_model_OR, type = "normalized")
sUAS_ndvi_model_OR_x <- fitted(sUAS_ndvi_model_OR)

sUAS_ndvi_model_ORresid_data <- data.frame(sUAS_ndvi_model_OR_x , sUAS_ndvi_model_OR_y)

ggplot( data = sUAS_ndvi_model_ORresid_data , aes( x = sUAS_ndvi_model_OR_x , y = sUAS_ndvi_model_OR_y)) +
  geom_point(mapping = aes(sUAS_ndvi_model_OR_x , sUAS_ndvi_model_OR_y) , data = sUAS_ndvi_model_ORresid_data)

hist(resid(sUAS_ndvi_model_OR))


plot(sUAS_ndvi_model_OR, site_year ~ resid(.), abline = 0)


qqnorm(sUAS_ndvi_model_OR, abline = c(0,1) )


qqnorm(resid(sUAS_ndvi_model_OR))
qqline(resid(sUAS_ndvi_model_OR))


qqnorm(sUAS_ndvi_model_OR , ~resid(.) | site_year)

plot(ranef(sUAS_ndvi_model_OR))

pairs(sUAS_ndvi_model_OR , id = 0.1)

qqnorm(sUAS_ndvi_model_OR , ~ranef(.))

plot( sUAS_ndvi_model_OR, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```


##emmeans

```{r}

mylist <- list(SI=seq(0.708 , 1 , by = .0001),TopDress_kgha =c( 34 , 0))

sUAS_ndvi_emmeans <- emmeans(sUAS_ndvi_model_OR , ~TopDress_kgha * SI , at = mylist )

sUAS_ndvi_emmeans_contrast <- as.data.frame(summary(contrast(sUAS_ndvi_emmeans , "pairwise" , side = ">" , by = "SI"))[1:7])

sUAS_ndvi_emmeans_contrast <- sUAS_ndvi_emmeans_contrast %>% 
  mutate(sUAS_ndvi_Response_Index = 1 / SI )

sUAS_ndvi_emmeans_contrast <- sUAS_ndvi_emmeans_contrast %>% 
  mutate(t_score = abs((estimate - 0.26)) / SE)

sUAS_ndvi_emmeans_contrast <- sUAS_ndvi_emmeans_contrast %>% 
  mutate(prob_greater_than_26 = if_else(estimate < 0.26 , pt(q = t_score , df = df , lower.tail = F) , pt(q = t_score , df = df , lower.tail = T)))

sUAS_ndvi_emmeans_contrast <- sUAS_ndvi_emmeans_contrast %>% 
  mutate(prob_diff_from_26 = 1 - (pt(q = t_score , df = df , lower.tail = F) + pt(q = -t_score , df = df , lower.tail = T)))

sUAS_ndvi_emmeans_contrast$sUAS_ndvi_Response_Index_r <- (round(sUAS_ndvi_emmeans_contrast$sUAS_ndvi_Response_Index , digits = 3))

sUAS_ndvi_run1 <- 125 - 100
sUAS_ndvi_rise1 <- 1.596946 - 0.2038182
sUAS_ndvi_slope1 <- round((sUAS_ndvi_rise1 / sUAS_ndvi_run1) * 5 , digits = 2)
sUAS_ndvi_slope1

sUAS_ndvi_run2 <- 142 - 125
sUAS_ndvi_rise2 <- 2.237784 - 1.596946 
sUAS_ndvi_slope2 <- round((sUAS_ndvi_rise2 / sUAS_ndvi_run2) * 5 , digits = 3)
sUAS_ndvi_slope2

sUAS_ndvi_mean_se <- sUAS_ndvi_emmeans_contrast %>% 
  select(SE) %>% 
  summarise(mean_se = mean(SE))

sUAS_ndvi_mean_se$mean_se <- round(sUAS_ndvi_mean_se$mean_se , digits = 2)

sUAS_ndvi_mean_se$mean_se

```

##confidence interval

```{r}

#at every 0.10 interval, what is the 90% confidence interval of the yield response, and what RI value does that range correspond with?

str(sUAS_ndvi_emmeans_contrast , give.attr = F)

sUAS_ndvi_emmeans_contrast <- sUAS_ndvi_emmeans_contrast %>% 
  mutate(response_mgha_r = round(estimate , digits = 2),
         se_mgha_r = round(SE , digits = 3))

#estimate = 0.20 , SE = 0.114

print(round(0.20 - z_score*0.114 , digits = 2))
print(round(0.20 + z_score*0.114 , digits = 2))


#estimate = 0.30 , SE = 0.104

print(round(0.30 - z_score*0.106 , digits = 2))
print(round(0.30 + z_score*0.106 , digits = 2))


#estimate = 0.40 , SE = 0.100

print(round(0.40 - z_score*0.100 , digits = 2))
print(round(0.40 + z_score*0.100 , digits = 2))

#estimate = 0.50 , SE = 0.099

print(round(0.50 - z_score*0.099 , digits = 2))
print(round(0.50 + z_score*0.099 , digits = 2))

```

##sUAS ndre

```{r}

sUAS_ndre_data <- paper3_data_no_2018 %>% 
  filter(Platform == "sUAS_NDRE")

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

sUAS_ndre_model <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = sUAS_ndre_data)

summary(sUAS_ndre_model)

summary(sUAS_ndre_model)$tTable

Anova(sUAS_ndre_model , type = 3)

r.squaredGLMM(sUAS_ndre_model)

```

## model diagnostics

```{r}

plot (sUAS_ndre_model)

plot(resid(sUAS_ndre_model, type = "normalized") ~fitted(sUAS_ndre_model))

sUAS_ndre_model_y <- resid(sUAS_ndre_model, type = "normalized")
sUAS_ndre_model_x <- fitted(sUAS_ndre_model)

sUAS_ndre_modelresid_data <- data.frame(sUAS_ndre_model_x , sUAS_ndre_model_y)

ggplot( data = sUAS_ndre_modelresid_data , aes( x = sUAS_ndre_model_x , y = sUAS_ndre_model_y)) +
  geom_point(mapping = aes(sUAS_ndre_model_x , sUAS_ndre_model_y) , data = sUAS_ndre_modelresid_data)

hist(resid(sUAS_ndre_model))


plot(sUAS_ndre_model, site_year ~ resid(.), abline = 0)


qqnorm(sUAS_ndre_model, abline = c(0,1) )


qqnorm(resid(sUAS_ndre_model))
qqline(resid(sUAS_ndre_model))


qqnorm(sUAS_ndre_model , ~resid(.) | site_year)

plot(ranef(sUAS_ndre_model))

pairs(sUAS_ndre_model , id = 0.1) 

qqnorm(sUAS_ndre_model , ~ranef(.))

plot( sUAS_ndre_model, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

##outlier removal 

```{r}

sUAS_ndre_data_OR <- sUAS_ndre_data[-(c(which(abs(residuals(sUAS_ndre_model, type = "normalized"))>qnorm(0.999)))),]

```

##rerun model sans outliers
```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

sUAS_ndre_model_OR <- lme(GrainYield_Mgha ~ SI * TopDress_kgha + I(SI*SI)  ,
             control = ctrl ,
             random = ~ I(TopDress_kgha) | site_year  , 
             data = sUAS_ndre_data_OR)

summary(sUAS_ndre_model_OR)

summary(sUAS_ndre_model_OR)$tTable

Anova(sUAS_ndre_model_OR , type = 3)

ndre_r_sq <- r.squaredGLMM(sUAS_ndre_model_OR)

ndre_r_sq_fixed <- round(ndre_r_sq[1] , digits = 2)
ndre_r_sq_fixed

ndre_r_sq_total <- round(ndre_r_sq[2] , digits = 2)
ndre_r_sq_total

ndre_r_sq_random <- ndre_r_sq_total - ndre_r_sq_fixed
ndre_r_sq_random


```

## model diagnostics

```{r}

plot (sUAS_ndre_model_OR)

plot(resid(sUAS_ndre_model_OR, type = "normalized") ~fitted(sUAS_ndre_model_OR))

sUAS_ndre_model_OR_y <- resid(sUAS_ndre_model_OR, type = "normalized")
sUAS_ndre_model_OR_x <- fitted(sUAS_ndre_model_OR)

sUAS_ndre_model_ORresid_data <- data.frame(sUAS_ndre_model_OR_x , sUAS_ndre_model_OR_y)

ggplot( data = sUAS_ndre_model_ORresid_data , aes( x = sUAS_ndre_model_OR_x , y = sUAS_ndre_model_OR_y)) +
  geom_point(mapping = aes(sUAS_ndre_model_OR_x , sUAS_ndre_model_OR_y) , data = sUAS_ndre_model_ORresid_data)

hist(resid(sUAS_ndre_model_OR))


plot(sUAS_ndre_model_OR, site_year ~ resid(.), abline = 0)


qqnorm(sUAS_ndre_model_OR, abline = c(0,1) )


qqnorm(resid(sUAS_ndre_model_OR))
qqline(resid(sUAS_ndre_model_OR))


qqnorm(sUAS_ndre_model_OR , ~resid(.) | site_year)

plot(ranef(sUAS_ndre_model_OR))

pairs(sUAS_ndre_model_OR , id = 0.1)

qqnorm(sUAS_ndre_model_OR , ~ranef(.))

plot( sUAS_ndre_model_OR, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```


##emmeans

```{r}

mylist <- list(SI=seq(0.528 , 1 , by = .0001),TopDress_kgha =c( 34 , 0))

sUAS_ndre_emmeans <- emmeans(sUAS_ndre_model_OR , ~TopDress_kgha * SI , at = mylist )

sUAS_ndre_emmeans_contrast <- as.data.frame(summary(contrast(sUAS_ndre_emmeans , "pairwise" , side = ">" , by = "SI"))[1:7])

sUAS_ndre_emmeans_contrast <- sUAS_ndre_emmeans_contrast %>% 
  mutate(sUAS_ndre_Response_Index = 1 / SI )

sUAS_ndre_emmeans_contrast <- sUAS_ndre_emmeans_contrast %>% 
  mutate(prob_postive_resp = (1 - p.value) * 100)

sUAS_ndre_emmeans_contrast <- sUAS_ndre_emmeans_contrast %>% 
  mutate(t_score = abs((estimate - 0.26)) / SE)

sUAS_ndre_emmeans_contrast <- sUAS_ndre_emmeans_contrast %>% 
  mutate(prob_greater_than_26 = if_else(estimate < 0.26 , pt(q = t_score , df = df , lower.tail = F) , pt(q = t_score , df = df , lower.tail = T)))

sUAS_ndre_emmeans_contrast$sUAS_ndre_Response_Index_r <- (round(sUAS_ndre_emmeans_contrast$sUAS_ndre_Response_Index , digits = 3))

sUAS_ndre_run1 <- 125 - 100
sUAS_ndre_rise1 <- 0.7890828 - 0.08455915
sUAS_ndre_slope1 <- round((sUAS_ndre_rise1 / sUAS_ndre_run1) * 5 , digits = 2)
sUAS_ndre_slope1

sUAS_ndre_run2 <- 189 - 125
sUAS_ndre_rise2 <- 1.747235 - 0.7890828 
sUAS_ndre_slope2 <- round((sUAS_ndre_rise2 / sUAS_ndre_run2) * 5 , digits = 3)
sUAS_ndre_slope2

sUAS_ndre_mean_se <- sUAS_ndre_emmeans_contrast %>% 
  select(SE) %>% 
  summarise(mean_se = mean(SE))

sUAS_ndre_mean_se$mean_se <- round(sUAS_ndre_mean_se$mean_se , digits = 2)

sUAS_ndre_mean_se$mean_se

```

##confidence interval

```{r}

#at every 0.10 interval, what is the 90% confidence interval of the yield response, and what RI value does that range correspond with?

str(sUAS_ndre_emmeans_contrast , give.attr = F)

sUAS_ndre_emmeans_contrast <- sUAS_ndre_emmeans_contrast %>% 
  mutate(response_mgha_r = round(estimate , digits = 2),
         se_mgha_r = round(SE , digits = 3))

#estimate = 0.10 , SE = 0.112

print(round(0.10 - z_score*0.112 , digits = 2))
print(round(0.10 + z_score*0.112 , digits = 2))

#estimate = 0.20 , SE = 0.103

print(round(0.20 - z_score*0.103 , digits = 2))
print(round(0.20 + z_score*0.103 , digits = 2))


#estimate = 0.30 , SE = 0.097

print(round(0.30 - z_score*0.097 , digits = 2))
print(round(0.30 + z_score*0.097 , digits = 2))


#estimate = 0.40 , SE = 0.093

print(round(0.40 - z_score*0.093 , digits = 2))
print(round(0.40 + z_score*0.093 , digits = 2))

#estimate = 0.50 , SE = 0.093

print(round(0.50 - z_score*0.093 , digits = 2))
print(round(0.50 + z_score*0.093 , digits = 2))

```

#CI PLOT
```{r}

estimated_yield_response <- seq(0.1 , 0.5 , by = 0.1)
index <- as.factor("GreenSeeker NDVI")
RI <- c('1.000' , '1.037' , '1.078' , '1.123' , '1.172')
lower_limit <- c('1.000' , '1.000', '1.010' , '1.049' , '1.091')
upper_limit <- c('1.078' , '1.114' , '1.157' , '1.208' , '1.265')
position <- seq(0.08 , 0.48 , by = 0.1)

ci_plot_data1 <- data.frame(index ,
                              estimated_yield_response ,
                              RI ,
                              lower_limit ,
                              upper_limit ,
                              position)

estimated_yield_response <- seq(0.1 , 0.5 , by = 0.1)
index <- as.factor("sUAS NDVI")
RI <- c(NA , '1.000' , '1.013' , '1.028' , '1.044')
lower_limit <- c(NA , '1.000' , '1.000', '1.005' , '1.019' )
upper_limit <- c(NA , '1.027' , '1.039' , '1.053' , '1.069' )
position <- seq(0.1 , 0.5 , by = 0.1)

ci_plot_data2 <- data.frame(index ,
                              estimated_yield_response ,
                              RI ,
                              lower_limit ,
                              upper_limit ,
                              position)

estimated_yield_response <- seq(0.1 , 0.5 , by = 0.1)
index <- as.factor("sUAS NDRE")
RI <- c('1.003' , '1.032' , '1.064' , '1.097' , '1.132')
lower_limit <- c('1.000' , '1.000' , '1.015', '1.048' , '1.080' )
upper_limit <- c('1.057' , '1.087' , '1.118' , '1.150' , '1.189' )
position <- seq(0.12 , 0.52 , by = 0.1)

ci_plot_data3 <- data.frame(index ,
                              estimated_yield_response ,
                              RI ,
                              lower_limit ,
                              upper_limit ,
                              position)

ci_plot_data <- rbind(ci_plot_data1 , ci_plot_data2 , ci_plot_data3)

ci_plot_data$RI <- as.numeric(ci_plot_data$RI)
ci_plot_data$lower_limit <- as.numeric(ci_plot_data$lower_limit)
ci_plot_data$upper_limit <- as.numeric(ci_plot_data$upper_limit)

```

```{r}

ci_plot <- ggplot(data = ci_plot_data , aes (y = RI , x = estimated_yield_response)) +
  geom_pointrange( data = ci_plot_data , aes(y = RI , x = position , ymin = lower_limit , ymax = upper_limit , color = index) , size = 1) +
  theme_classic() +
  scale_y_continuous(breaks = seq(1 , 1.28 , by = 0.05)) +
  geom_hline(yintercept = 1) +
  labs(x = "Estimated Grain Yield Response ( Mg ha"^-1~")" , y = "Response Index Value" , color = "Index") +
  theme(axis.title = element_text(size = 26),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24)
        )

ci_plot

ggsave("FIGURES/Paper3_CI_plot.tiff" , ci_plot , compression = "lzw" , width = 15 , height = 12, type = "cairo" , dpi = 500)

```



#PLOT

```{r}

p3_plot_1 <- ggplot( data = gs_ndvi_emmeans_contrast , aes ( x = GS_NDVI_Response_Index , y = estimate )) +
  theme_classic() +
  theme(axis.title = element_text(size = 34)) +
  theme(axis.text = element_text(size = 34)) +
  theme(legend.text = element_text(size = 26)) +
  theme(legend.title = element_text(size = 26)) +
  coord_cartesian(ylim = c( 0, 2.6) , xlim = c(1 , 4)) +
  scale_x_continuous(breaks = seq(1.00 , 4.00 , by = 0.5)) +
  scale_y_continuous(breaks = seq(0 , 2.5 , by = 0.5)) +
  theme(panel.background = element_rect(fill = "white", color = "grey0")) +
  labs( x = "Response-Index" , y = "Estimated Grain Yield Response to Top-dress N ( Mg ha"^-1~")" , linetype = "Legend" , color = "Legend" , size = "Legend") +
  
  geom_line(data = gs_ndvi_emmeans_contrast, aes( x = GS_NDVI_Response_Index , y = estimate , linetype = "RI-NDVI[GS]" , size =  "RI-NDVI[GS]" , color = "RI-NDVI[GS]")) +
  geom_ribbon(data = gs_ndvi_emmeans_contrast , aes(x = GS_NDVI_Response_Index, y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , alpha = 0.2) +
  
  geom_line(data = sUAS_ndvi_emmeans_contrast, aes( x = sUAS_ndvi_Response_Index , y = estimate , linetype = "RI-NDVI[UAS]" , size =  "RI-NDVI[UAS]" , color = "RI-NDVI[UAS]" )) +
  geom_ribbon(data = sUAS_ndvi_emmeans_contrast , aes(x = sUAS_ndvi_Response_Index , y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , alpha = 0.2) +
  
  geom_line(data = sUAS_ndre_emmeans_contrast, aes( x = sUAS_ndre_Response_Index , y = estimate , linetype = "RI-NDRE[UAS]" , size =  "RI-NDRE[UAS]" , color = "RI-NDRE[UAS]" )) +
  geom_ribbon(data = sUAS_ndre_emmeans_contrast , aes(x = sUAS_ndre_Response_Index,  y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , alpha = 0.2) +
  
  scale_linetype_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( "solid" , "dashed" , "dotdash")) +
  scale_color_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( "dodgerblue3" , "firebrick3" , "forestgreen")) +
  scale_size_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( 4 , 4 , 4)) +
  
  guides(linetype = guide_legend(keywidth = 12 , keyheight = 2.6 , unit = "cm" , override.aes = list(size = 3) , title.hjust = 0.5)) +
  theme(legend.position = c(0.32, 0.17)) +
  geom_hline(yintercept = 0 , size = 1) +
  geom_segment(aes(x = 1.063264, y = 0, xend = 1.063264, yend = Inf), linetype = "solid" , size  = 2 , color = "dodgerblue3" ) +
  geom_segment(aes(x = 1.008573, y = 0, xend = 1.008573, yend = Inf) ,linetype = "dashed" , size = 2 , color = "firebrick3" ) +
  geom_segment(aes(x = 1.052632, y = 0, xend = 1.052632, yend = Inf), linetype = "dotdash" , size = 2 , color = "forestgreen")

                 
p3_plot_1

ggsave("FIGURES/Paper3_Fig_4.tiff" , p3_plot_1 , compression = "lzw" , width = 22 , height = 15, type = "cairo" , dpi = 500)
```

```{r}

p3_plot_2 <- ggplot( data = gs_ndvi_emmeans_contrast , aes ( x = GS_NDVI_Response_Index , y = estimate )) +
  theme_classic() +
  theme(axis.title = element_text(size = 24)) +
  theme(axis.text = element_text(size = 24)) +
  theme(legend.text = element_text(size = 32)) +
  theme(legend.title = element_text(size = 35)) +
  coord_cartesian(ylim = c( 0, .75) , xlim = c(1 , 1.12)) +
  scale_x_continuous(breaks = seq(1.00 , 1.12 , by = 0.02)) +
  scale_y_continuous(breaks = seq(0 , 1 , by = 0.25)) +
  theme(panel.background = element_rect(fill = "white", color = "grey0")) +
  labs( x = "Response-Index" , y = "Estimated Grain Yield Response to Top-dress N ( Mg ha"^-1~")" , linetype = "Legend" , color = "Legend" , size = "Legend") +
  geom_line(data = gs_ndvi_emmeans_contrast, aes( x = GS_NDVI_Response_Index , y = estimate , linetype = "RI-NDVI[GS]" , size =  "RI-NDVI[GS]" , color = "RI-NDVI[GS]")) +
  geom_ribbon(data = gs_ndvi_emmeans_contrast , aes(x = GS_NDVI_Response_Index, y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , color = "dodgerblue3" , alpha = 0.2) +
  
  geom_line(data = sUAS_ndvi_emmeans_contrast, aes( x = sUAS_ndvi_Response_Index , y = estimate , linetype = "RI-NDVI[UAS]" , size =  "RI-NDVI[UAS]" , color = "RI-NDVI[UAS]" )) +
  geom_ribbon(data = sUAS_ndvi_emmeans_contrast , aes(x = sUAS_ndvi_Response_Index , y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , color = "firebrick3" , alpha = 0.2) +
  
  geom_line(data = sUAS_ndre_emmeans_contrast, aes( x = sUAS_ndre_Response_Index , y = estimate , linetype = "RI-NDRE[UAS]" , size =  "RI-NDRE[UAS]" , color = "RI-NDRE[UAS]" )) +
  geom_ribbon(data = sUAS_ndre_emmeans_contrast , aes(x = sUAS_ndre_Response_Index,  y = estimate , ymax = (estimate + SE) , ymin = (estimate - SE) ) , color = "forestgreen" , alpha = 0.2) +
  
  scale_linetype_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( "solid" , "dashed" , "dotdash")) +
  scale_color_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( "dodgerblue3" , "firebrick3" , "forestgreen")) +
  scale_size_manual("Legend", breaks = c("RI-NDVI[GS]" , "RI-NDVI[UAS]" , "RI-NDRE[UAS]" ) , values = c( 4 , 4 , 4)) +
  
  guides(linetype = guide_legend(keywidth = 15 , keyheight = 2.6 , unit = "cm" , override.aes = list(size = 3) , title.hjust = 0.5)) +
  theme(legend.position = "none") +
  geom_hline(yintercept = 0) +
  geom_segment(aes(x = 1.063264, y = 0, xend = 1.063264, yend = Inf), linetype = "solid" , size  = 2 , color = "dodgerblue3" ) +
  geom_segment(aes(x = 1.008166, y = 0, xend = 1.008166, yend = Inf) ,linetype = "dashed" , size = 2 , color = "firebrick3" ) +
  geom_segment(aes(x = 1.052632, y = 0, xend = 1.052632, yend = Inf), linetype = "dotdash" , size = 2 , color = "forestgreen")

                 
p3_plot_2

```

##CONF INT
```{r}

0.2604741 + 0.1075889
0.2604741 - 0.1075889

0.2602399 + 0.1084718
0.2602399 - 0.1084718

0.26069007 + 0.09894181
0.26069007 - 0.09894181

breakpoint_platform <- c("GreenSeekerNDVI" , "sUAS_NDVI" , "sUAS_NDRE")
breakpoint_platform <- as.factor(breakpoint_platform)
breakpoint_yield <- c(0.26 , 0.32 , 0.20)
breakpoint_RI <- c(1.063264 , 1.008166 , 1.052632)
breakpoint_RI_min <- c(1.019888 , 1 , 1.022390)
breakpoint_RI_max <- c(1.110494 , 1.027010 , 1.084716)

conf_int_data <- data.frame(breakpoint_platform , breakpoint_yield , breakpoint_RI , breakpoint_RI_min , breakpoint_RI_max)

```

```{r}

p3_plot_2_CI <- p3_plot_2 +
  geom_point(mapping = aes ( x = breakpoint_RI , y = breakpoint_yield) , data = conf_int_data , shape = 1) +
  geom_pointrange(data= conf_int_data, mapping = aes(
                                                y = breakpoint_yield, 
                                                x = breakpoint_RI ,
                                                xmin = breakpoint_RI_min, 
                                                xmax = breakpoint_RI_max), 
                  linetype = 1,
                  size = 15,
                  shape = 21,
                  fatten = .5,
                  alpha = .4,
                  color = c("dodgerblue3" ,"firebrick3" , "forestgreen"),
                  )

p3_plot_2_CI

ggsave("FIGURES/Paper3_Fig_4_inset.tiff" , p3_plot_2_CI , compression = "lzw" , width =  17, height = 10, type = "cairo" , dpi = 500)

```



#FIGURE 3

```{r}

Paper3_RI_fig <- ggdraw() +
  draw_plot(p3_plot_1) +
  draw_plot(p3_plot_2_CI , x = .57 , y = .13 , width = .41 , height = .4)

ggsave("FIGURES/Paper3_Fig_4_v2.tiff" , Paper3_RI_fig , compression = "lzw" , width = 22 , height = 14, type = "cairo" , dpi = 500)

```

