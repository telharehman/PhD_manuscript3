---
title: "Untitled3"
author: "Telha H. Rehman"
output:
  pdf_document: default
  html_document: default
---

# R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r}
Sys.time()
```

```{r, echo = FALSE}

library(knitr)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_knit$set(root.dir = "~/Desktop/Ph.D. Horticulture and Agronomy/PhD_manuscript3/R_project/PhD_manuscript3")
```

```{r , message=FALSE}

library(tinytex)
library(tidyverse)
library(cowplot)
library(Cairo)
library(modelr)
library(gridExtra)
library(mixtools)
library(nlme)
library(car)
library(emmeans)
library(MuMIn)
library(ggpmisc)
library(gtable)
library(grid)
library(RColorBrewer)
library(segmented)
library(data.table)
library(scales)
library(sm)
library(rcompanion)
library(nlstools)

```

## DATA

### GreenSeeker NDVI Data

```{r}

gs_ndvi_data <- read_csv(file = "DATA/PI_greenseeker_data.csv")

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <- gs_ndvi_data %>% 
  filter(!year %in% c("2015" , "2016") & N_level_kgha != 275) #remove the years we don't need for this analysis and also the N rate that is too high 

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <- gs_ndvi_data[c(1:240), c(1:17)] #removes the empty rows and columns from the data frame

gs_ndvi_data$block <- factor(gs_ndvi_data$block) 
gs_ndvi_data$year <- factor(gs_ndvi_data$year)
gs_ndvi_data$plot <- factor(gs_ndvi_data$plot) 
gs_ndvi_data$N_level_kgha_f <- factor(gs_ndvi_data$N_level_kgha)
gs_ndvi_data$exp_plot_number <- factor(gs_ndvi_data$exp_plot_number)
gs_ndvi_data$site_year <- factor(gs_ndvi_data$site_year , levels = c( "Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19" ))
gs_ndvi_data$NDVI_1 <- as.numeric(as.character(gs_ndvi_data$NDVI_1))
gs_ndvi_data$NDVI_2 <- as.numeric(as.character(gs_ndvi_data$NDVI_2))
gs_ndvi_data$NDVI_3 <- as.numeric(as.character(gs_ndvi_data$NDVI_3))
gs_ndvi_data$NDVI_4 <- as.numeric(as.character(gs_ndvi_data$NDVI_4)) #gets the data right

str(gs_ndvi_data , give.attr = FALSE)

gs_ndvi_data <-  gs_ndvi_data %>% 
  mutate( biomass_dry_wt = biomass_plus_bag_g - (paper_bag_g * num_of_paper_bags) ,
          aboveground_biomass = (biomass_dry_wt / ring_size) * 10 ,
          n_content = sample_N_ug / sample_weight_mg ,
          PI_N_Uptake = (aboveground_biomass * n_content) / 1000 #n uptake in kg per ha
          )#processes the data


gs_ndvi_data <- gs_ndvi_data %>% 
  rowwise() %>% 
  mutate(NDVI = mean(c( NDVI_1 , NDVI_2 , NDVI_3 , NDVI_4) , na.rm = T)) #takes average of four NDVI readings

gs_ndvi_data <- dplyr::select(gs_ndvi_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      block,
                      plot,
                      N_level_kgha,
                      aboveground_biomass,
                      n_content,
                      PI_N_Uptake,
                      NDVI) #selects the relevant columns

gs_ndvi_data$site_year <- factor(gs_ndvi_data$site_year , levels = c( "Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19")) #orders site-years alphabetically

hist(gs_ndvi_data$aboveground_biomass)
hist(gs_ndvi_data$n_content)
hist(gs_ndvi_data$PI_N_Uptake)
```

### Yield Data

```{r}

yield_data <- read_csv(file = "DATA/yield_data.csv")

str(yield_data , give.attr = FALSE)

yield_data <- yield_data %>% 
  filter(!year %in% c( "2016") & TopDress_kgha == 0 & N_level_kgha != 275) #removing the years and  N rate to match with NDVI data

yield_data <- yield_data %>% 
  mutate(
    site_year = factor(site_year),
    year = factor(year),
    Block = factor(Block),
    MainPlot = factor(MainPlot),
    exp_plot_number = factor(exp_plot_number),
    N_level = factor(N_level),
    SubPlot = factor(SubPlot),
    TopDress = factor(TopDress),
    SeasonalNRate_f = factor(SeasonalNRate),
    N_level_kgha_f = factor(N_level_kgha),
    TopDress_kgha_f = factor(TopDress_kgha),
    SeasonalNRate_kgha_f = factor(SeasonalNRate_kgha)
    ) #changes these columns to factor

str(yield_data , give.attr = FALSE)

yield_data <- yield_data %>% 
  mutate(
    FW1net = FW1PlusTare - tare,
    FW2net = FW2PlusTare - tare,
    TotalFW = FW1net + FW2net,
    SSFWnet = SSFWPlusTare - tare,
    Ratio = SSFWnet / TotalFW, 
    SSODWnet = SSODW - HarvestBagPlusTie, 
    SeedTray1 = SeedTray1.1 + SeedTray1.2, #adds the decimal to the 243g to get the tare weight for the seedtray
    Grain3net = Grain3PlusSeedTray1 - SeedTray1, #subtract tare of seed tray from grain3. Grain3 is the reweighed sample value
    Grain4net = Grain4PlusSeedTray2 - SeedTray2, #grain4 is the amount of grain removed for ballmilling. this value came from another excel sheet
    Grain2net = Grain2PlusPaperBag2 - PaperBag2, #yield component grain sample
    Grain2net = Grain2net * Ratio, #this essentially subsamples the yield component grain sample
    GrainNet = Grain3net + Grain4net + Grain2net, #add the grain removed for ball milling and yield component back to the reweighed grain sample
    GrainRing = GrainNet / Ratio, #the amount of grain in the entire m^2 ring in grams
    GrainYield = GrainRing * 10, #g/m^2 to kg/ha
    GrainYield_kgha = GrainYield * ((100-MoistureContentGrain3)/86),#corrects for 14% moisture based on the moisture content readings from grain reweighing. values came from another excel sheet
    GrainYield_Mgha = GrainYield_kgha / 1000 , #converts kg/ha to Mg/ha
    Grain5 = GrainRing * ((100-MoistureContentGrain3)/98.1), #grain in the ring if the subsample was at 1.9% moisture
    Grain6 = GrainNet * ((100-MoistureContentGrain3)/98.1), #grain in the subsample if it was at 1.9% moisture
    StrawSS = SSODWnet - Grain6 , #just straw in subsample in grams 
    StrawRing = StrawSS / Ratio, #straw in ring in grams i.e g/m2
    StrawNcon = StrawN / StrawSampleSize,
    StrawNup = (StrawRing * StrawNcon) / 100, #straw Nup divide by 100 to convert mg/m2 to kg/ha - this is correct
    GrainNcon = (GrainN / GrainSampleSize), #grain in ring in kg/ha
    GrainNup = (Grain5 * GrainNcon) / 100, #grain Nup divide by 100 to convert mg N/m2 to kg N/ha
    TotalSeasonalNup = StrawNup + GrainNup, #in kg/ha
    HarvestIndex = Grain5 / (Grain5 + StrawRing),
    Moisture = SSFWnet / SSODWnet
    )

boxplot(yield_data$GrainYield_Mgha)
hist(yield_data$GrainYield_Mgha)

boxplot(yield_data$HarvestIndex)
hist(yield_data$HarvestIndex)

boxplot(yield_data$Moisture)
hist(yield_data$Moisture)

```

```{r}

#the data looks good - don't see any unusual values


yield_data <- dplyr::select(yield_data,
                               site_year,
                               year,
                               Block,
                               MainPlot,
                               SubPlot,
                               exp_plot_number,
                               N_level_kgha,
                               N_level_kgha_f,
                               TopDress_kgha, 
                               TopDress_kgha_f,
                               GrainYield_Mgha
                               )
           

gs_data <- full_join(gs_ndvi_data , yield_data)

gs_data <- dplyr::select(gs_data, 
               site_year, 
               year, 
               exp_plot_number, 
               Block, 
               MainPlot, 
               SubPlot,
               N_level_kgha,
               N_level_kgha_f,
               TopDress_kgha, 
               TopDress_kgha_f , 
               PI_N_Uptake, 
               NDVI, 
               GrainYield_Mgha) #reorders the columns

gs_data$site_year <- as.factor(gs_data$site_year)

str(gs_data , give.attr = FALSE)

boxplot(gs_data$GrainYield_Mgha)

hist(gs_data$GrainYield_Mgha)

hist(gs_data$NDVI)

boxplot(gs_data$NDVI)

boxplot(gs_data$PI_N_Uptake)

hist(gs_data$PI_N_Uptake)

#Overall data looks good -- no errors of data entry

```

### Calculating GS RI

```{r}

max_gs_ndvi <- gs_data %>% 
  filter(N_level_kgha_f %in% c(225, 235)) %>% 
  dplyr::select(site_year , NDVI) %>% 
  group_by(site_year) %>% 
  summarise(mean_NDVI = mean(NDVI))

nic17 <- subset(max_gs_ndvi, site_year == "Nicolaus-17")
nic17maxNDVI <- nic17$mean_NDVI
nic17maxNDVI <- as.numeric(nic17maxNDVI)
nic17maxNDVI

wil17 <- subset(max_gs_ndvi, site_year == "Williams-17")
wil17maxNDVI <- wil17$mean_NDVI
wil17maxNDVI <- as.numeric(wil17maxNDVI)
wil17maxNDVI

arb18 <- subset(max_gs_ndvi, site_year == "Arbuckle-18")
arb18maxNDVI <- arb18$mean_NDVI
arb18maxNDVI <- as.numeric(arb18maxNDVI)
arb18maxNDVI

biggs18 <- subset(max_gs_ndvi, site_year == "Biggs-18")
biggs18maxNDVI <- biggs18$mean_NDVI
biggs18maxNDVI <- as.numeric(biggs18maxNDVI)
biggs18maxNDVI

mry18 <- subset(max_gs_ndvi, site_year == "Marysville-18")
mry18maxNDVI <- mry18$mean_NDVI
mry18maxNDVI <- as.numeric(mry18maxNDVI)
mry18maxNDVI

nic18 <- subset(max_gs_ndvi, site_year == "Nicolaus-18")
nic18maxNDVI <- nic18$mean_NDVI
nic18maxNDVI <- as.numeric(nic18maxNDVI)
nic18maxNDVI

arb19 <- subset(max_gs_ndvi, site_year == "Arbuckle-19")
arb19maxNDVI <- arb19$mean_NDVI
arb19maxNDVI <- as.numeric(arb19maxNDVI)
arb19maxNDVI

davis19 <- subset(max_gs_ndvi, site_year == "Davis-19")
davis19maxNDVI <- davis19$mean_NDVI
davis19maxNDVI <- as.numeric(davis19maxNDVI)
davis19maxNDVI

mry19 <- subset(max_gs_ndvi, site_year == "Marysville-19")
mry19maxNDVI <- mry19$mean_NDVI
mry19maxNDVI <- as.numeric(mry19maxNDVI)
mry19maxNDVI

res19 <- subset(max_gs_ndvi, site_year == "RES-19")
res19maxNDVI <- res19$mean_NDVI
res19maxNDVI <- as.numeric(res19maxNDVI)
res19maxNDVI

gs_data <- gs_data %>% 
  mutate(max_NDVI = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxNDVI ,
                          site_year == "Williams-17" ~ wil17maxNDVI ,
                          site_year == "Arbuckle-18" ~ arb18maxNDVI ,
                          site_year == "Biggs-18" ~ biggs18maxNDVI ,
                          site_year == "Marysville-18" ~ mry18maxNDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxNDVI,
                          site_year == "Arbuckle-19" ~ arb19maxNDVI ,
                          site_year == "Davis-19" ~ davis19maxNDVI ,
                          site_year == "Marysville-19" ~ mry19maxNDVI ,
                          site_year == "RES-19" ~ res19maxNDVI)
  )

gs_data <- gs_data %>%
  mutate(gs_NDVI_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxNDVI / NDVI,
                          site_year == "Williams-17" ~ wil17maxNDVI / NDVI,
                          site_year == "Arbuckle-18" ~ arb18maxNDVI / NDVI ,
                          site_year == "Biggs-18" ~ biggs18maxNDVI / NDVI ,
                          site_year == "Marysville-18" ~ mry18maxNDVI / NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxNDVI / NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxNDVI / NDVI,
                          site_year == "Davis-19" ~ davis19maxNDVI / NDVI,
                          site_year == "Marysville-19" ~ mry19maxNDVI / NDVI,
                          site_year == "RES-19" ~ res19maxNDVI / NDVI
                        )) #calculates NDVI response index

str(gs_data , give.attr = FALSE)

hist(gs_data$gs_NDVI_Response_Index)
boxplot(gs_data$gs_NDVI_Response_Index)
hist(gs_data$GrainYield_Mgha)
boxplot(gs_data$GrainYield_Mgha)

```

### Drone Data

```{r}

drone_data <- read_csv(file = "DATA/PI_drone_data.csv")

str(drone_data , give.attr = FALSE)

drone_data <- drone_data %>% 
  filter(N_level_kgha != 275) %>% 
  mutate(year = factor(year) ,
         exp_plot_number = factor(exp_plot_number) ,
         Block = factor(Block) ,
         MainPlot = factor(MainPlot) ,
         N_level = factor(N_level) ,
         N_level_kgha_f = factor(N_level_kgha)
  )

drone_data$site_year <- factor(drone_data$site_year , levels = c("Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19"))

str(drone_data , give.attr = FALSE)


drone_data <- dplyr::select(drone_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      N_level,
                      N_level_kgha,
                      N_level_kgha_f,
                      biomass_plus_bag_g,
                      ring_size,
                      paper_bag_g,
                      num_of_paper_bags,
                      sample_weight_mg,
                      sample_N_ug,
                      bluemean,
                      greenmean,
                      redmean,
                      edgemean,
                      nirmean
                      )#selects the relevant columns

str(drone_data , give.attr = FALSE)

#visualize drone_data to look for outliers

boxplot(drone_data$bluemean)
hist(drone_data$bluemean)

boxplot(drone_data$greenmean)
hist(drone_data$greenmean)

boxplot(drone_data$redmean)
hist(drone_data$redmean)

boxplot(drone_data$edgemean)
hist(drone_data$edgemean)

boxplot(drone_data$nirmean)
hist(drone_data$nirmean)

```

```{r}

drone_data <-  drone_data %>% 
  mutate( biomass_dry_wt = biomass_plus_bag_g - (paper_bag_g * num_of_paper_bags) ,
          aboveground_biomass = (biomass_dry_wt / ring_size) * 10 , #ring size 0.5 m^2 biomass in kg per ha
          n_content = sample_N_ug / sample_weight_mg ,
          PI_N_Uptake = (aboveground_biomass * n_content) / 1000 #n uptake in kg per ha
          )#processes the data2

boxplot(drone_data$PI_N_Uptake)
hist(drone_data$PI_N_Uptake)

drone_data <- drone_data %>% 
  mutate(uas_NDRE = ((nirmean - edgemean) / (nirmean + edgemean)) ,
         uas_NDVI = ((nirmean - redmean) / (nirmean + redmean))
         ) #calculates NDRE and NDVI

boxplot(drone_data$uas_NDRE)
hist(drone_data$uas_NDRE)

boxplot(drone_data$uas_NDVI)
hist(drone_data$uas_NDVI)

ggplot(data = drone_data, aes(x = PI_N_Uptake , y = uas_NDRE )) +
  geom_point(mapping = aes(x = PI_N_Uptake , y = uas_NDRE , shape = site_year) , data = drone_data) +
  theme_classic() +
  scale_shape_manual(values = seq(4:20)) +
  coord_cartesian(ylim = c(0,1))

ggplot(data = drone_data, aes(x = PI_N_Uptake , y = uas_NDVI )) +
  geom_point(mapping = aes(x = PI_N_Uptake , y = uas_NDVI , shape = site_year) , data = drone_data) +
  theme_classic() +
  scale_shape_manual(values = seq(4:20)) +
  coord_cartesian(ylim = c(0,1))


```

### Calculating UAS RI

```{r}
#gets the max NDRE value for each site

max_drone_data <- drone_data %>% 
  filter(N_level_kgha_f %in% c(225, 235)) %>% 
  dplyr::select(site_year , uas_NDVI , uas_NDRE) %>% 
  group_by(site_year) %>% 
  summarise_all(.funs = mean) %>% 
  ungroup()

nic17 <- subset(max_drone_data, site_year == "Nicolaus-17")
nic17maxuas_NDRE <- as.numeric(nic17$uas_NDRE)
nic17maxuas_NDRE
nic17maxuas_NDVI <- as.numeric(nic17$uas_NDVI)
nic17maxuas_NDVI

wil17 <- subset(max_drone_data, site_year == "Williams-17")
wil17maxuas_NDRE <- as.numeric(wil17$uas_NDRE)
wil17maxuas_NDRE
wil17maxuas_NDVI <- as.numeric(wil17$uas_NDVI)
wil17maxuas_NDVI

arb18 <- subset(max_drone_data, site_year == "Arbuckle-18")
arb18maxuas_NDRE <- as.numeric(arb18$uas_NDRE)
arb18maxuas_NDRE
arb18maxuas_NDVI <- as.numeric(arb18$uas_NDVI)
arb18maxuas_NDVI

biggs18 <- subset(max_drone_data, site_year == "Biggs-18")
biggs18maxuas_NDRE <- as.numeric(biggs18$uas_NDRE)
biggs18maxuas_NDRE
biggs18maxuas_NDVI <- as.numeric(biggs18$uas_NDVI)
biggs18maxuas_NDVI

mry18 <- subset(max_drone_data, site_year == "Marysville-18")
mry18maxuas_NDRE <- as.numeric(mry18$uas_NDRE)
mry18maxuas_NDRE
mry18maxuas_NDVI <- as.numeric(mry18$uas_NDVI)
mry18maxuas_NDVI

nic18 <- subset(max_drone_data, site_year == "Nicolaus-18")
nic18maxuas_NDRE <- as.numeric(nic18$uas_NDRE)
nic18maxuas_NDRE
nic18maxuas_NDVI <- as.numeric(nic18$uas_NDVI)
nic18maxuas_NDVI

arb19 <- subset(max_drone_data, site_year == "Arbuckle-19")
arb19maxuas_NDRE <- as.numeric(arb19$uas_NDRE)
arb19maxuas_NDRE
arb19maxuas_NDVI <- as.numeric(arb19$uas_NDVI)
arb19maxuas_NDVI

davis19 <- subset(max_drone_data, site_year == "Davis-19")
davis19maxuas_NDRE <- as.numeric(davis19$uas_NDRE)
davis19maxuas_NDRE
davis19maxuas_NDVI <- as.numeric(davis19$uas_NDVI)
davis19maxuas_NDVI

mry19 <- subset(max_drone_data, site_year == "Marysville-19")
mry19maxuas_NDRE <- as.numeric(mry19$uas_NDRE)
mry19maxuas_NDRE
mry19maxuas_NDVI <- as.numeric(mry19$uas_NDVI)
mry19maxuas_NDVI

res19 <- subset(max_drone_data, site_year == "RES-19")
res19maxuas_NDRE <- as.numeric(res19$uas_NDRE)
res19maxuas_NDRE
res19maxuas_NDVI <- as.numeric(res19$uas_NDVI)
res19maxuas_NDVI

drone_data <- drone_data %>% 
  mutate(max_uas_NDRE = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDRE ,
                          site_year == "Williams-17" ~ wil17maxuas_NDRE ,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDRE ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDRE ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDRE ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDRE,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDRE ,
                          site_year == "Davis-19" ~ davis19maxuas_NDRE ,
                          site_year == "Marysville-19" ~ mry19maxuas_NDRE ,
                          site_year == "RES-19" ~ res19maxuas_NDRE) #assign the max NDRE value for each site
  )

drone_data <- drone_data %>%
  mutate(uas_NDRE_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDRE / uas_NDRE,
                          site_year == "Williams-17" ~ wil17maxuas_NDRE / uas_NDRE,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDRE / uas_NDRE  ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDRE / uas_NDRE ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDRE / uas_NDRE ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDRE / uas_NDRE,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDRE / uas_NDRE,
                          site_year == "Davis-19" ~ davis19maxuas_NDRE / uas_NDRE,
                          site_year == "Marysville-19" ~ mry19maxuas_NDRE / uas_NDRE,
                          site_year == "RES-19" ~ res19maxuas_NDRE / uas_NDRE
                        )) #calculates uas_NDRE response index

drone_data <- drone_data %>% 
  mutate(max_uas_NDVI = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDVI ,
                          site_year == "Williams-17" ~ wil17maxuas_NDVI ,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDVI ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDVI ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDVI ,
                          site_year == "Davis-19" ~ davis19maxuas_NDVI ,
                          site_year == "Marysville-19" ~ mry19maxuas_NDVI ,
                          site_year == "RES-19" ~ res19maxuas_NDVI) #assign max ndvi value for each site
  )

drone_data <- drone_data %>%
  mutate(uas_NDVI_Response_Index = case_when(
                          site_year == "Nicolaus-17" ~ nic17maxuas_NDVI / uas_NDVI,
                          site_year == "Williams-17" ~ wil17maxuas_NDVI / uas_NDVI,
                          site_year == "Arbuckle-18" ~ arb18maxuas_NDVI / uas_NDVI  ,
                          site_year == "Biggs-18" ~ biggs18maxuas_NDVI / uas_NDVI ,
                          site_year == "Marysville-18" ~ mry18maxuas_NDVI / uas_NDVI ,
                          site_year == "Nicolaus-18" ~ nic18maxuas_NDVI / uas_NDVI,
                          site_year == "Arbuckle-19" ~ arb19maxuas_NDVI / uas_NDVI,
                          site_year == "Davis-19" ~ davis19maxuas_NDVI / uas_NDVI,
                          site_year == "Marysville-19" ~ mry19maxuas_NDVI / uas_NDVI,
                          site_year == "RES-19" ~ res19maxuas_NDVI / uas_NDVI
                        )) #calculates uas_NDVI response index

str(drone_data , give.attr =  F)

boxplot(drone_data$uas_NDRE_Response_Index)
hist(drone_data$uas_NDRE_Response_Index)

boxplot(drone_data$uas_NDVI_Response_Index)
hist(drone_data$uas_NDVI_Response_Index)

```

```{r}

drone_data <- dplyr::select(drone_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      N_level_kgha,
                      N_level_kgha_f,
                      PI_N_Uptake,
                      uas_NDRE,
                      uas_NDVI,
                      uas_NDRE_Response_Index,
                      uas_NDVI_Response_Index
                      )#selects the relevant columns

sUAS_yield_data <- yield_data

sUAS_yield_data$site_year <- factor(sUAS_yield_data$site_year , levels = c("Nicolaus-17" , "Williams-17" , "Arbuckle-18" , "Biggs-18" , "Marysville-18" , "Nicolaus-18" , "Arbuckle-19" , "Davis-19" , "Marysville-19" , "RES-19"))

str(drone_data , give.attr = F)
str(sUAS_yield_data , give.attr = F)

sUAS_data <- full_join( drone_data , sUAS_yield_data)

sUAS_data <- dplyr::select(sUAS_data ,
                      site_year,
                      year,
                      exp_plot_number,
                      Block,
                      MainPlot,
                      SubPlot,
                      N_level_kgha,
                      N_level_kgha_f,
                      TopDress_kgha,
                      TopDress_kgha_f,
                      PI_N_Uptake,
                      uas_NDRE,
                      uas_NDVI,
                      GrainYield_Mgha,
                      uas_NDRE_Response_Index,
                      uas_NDVI_Response_Index
                      )#selects the relevant columns


str(sUAS_data , give.attr = F)

```

### Combining the data

```{r}

gs_data <- gs_data %>% 
  mutate(gs_NDVI_SI = 1 / gs_NDVI_Response_Index)

sUAS_data <- sUAS_data %>% 
  mutate(uas_NDVI_SI = 1 / uas_NDVI_Response_Index)

sUAS_data <- sUAS_data %>% 
  mutate(uas_NDRE_SI = 1 / uas_NDRE_Response_Index)

gs_data <- gs_data %>% 
  dplyr::select(site_year ,
                year,
                exp_plot_number,
                Block,
                MainPlot,
                SubPlot,
                N_level_kgha,
                N_level_kgha_f,
                TopDress_kgha,
                TopDress_kgha_f,
                PI_N_Uptake, 
                NDVI, 
                GrainYield_Mgha,
                gs_NDVI_Response_Index,
                gs_NDVI_SI
         )

sUAS_data <- sUAS_data %>% 
  dplyr::select(site_year ,
                year,
                exp_plot_number,
                Block,
                MainPlot,
                SubPlot,
                N_level_kgha,
                N_level_kgha_f,
                TopDress_kgha,
                TopDress_kgha_f,
                uas_NDRE,
                uas_NDVI,
                uas_NDVI_Response_Index,
                uas_NDVI_SI,
                uas_NDRE_Response_Index,
                uas_NDRE_SI
         )

paper3_data <- full_join(gs_data , sUAS_data)

paper3_gsdata <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                NDVI,
                gs_NDVI_Response_Index,
                gs_NDVI_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "GreenSeeker NDVI" ) %>% 
  rename(Index = NDVI , 
         SI = gs_NDVI_SI,
         RI = gs_NDVI_Response_Index)

paper3_uas_ndvi_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                uas_NDVI,
                uas_NDVI_Response_Index,
                uas_NDVI_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "sUAS NDVI" ) %>% 
  rename(Index = uas_NDVI,
         SI = uas_NDVI_SI,
         RI = uas_NDVI_Response_Index)

paper3_uas_ndre_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                uas_NDRE ,
                uas_NDRE_Response_Index ,
                uas_NDRE_SI ,
                GrainYield_Mgha,
                PI_N_Uptake) %>% 
  mutate(Platform = "sUAS NDRE" ) %>% 
  rename(Index = uas_NDRE ,
         SI = uas_NDRE_SI,
         RI = uas_NDRE_Response_Index)

paper3_data <- rbind(paper3_gsdata ,
                     paper3_uas_ndvi_data , 
                     paper3_uas_ndre_data)

paper3_data <- paper3_data %>% 
  dplyr::select(site_year , 
                year , 
                Platform,
                exp_plot_number ,
                Block ,
                MainPlot ,
                SubPlot ,
                N_level_kgha ,
                N_level_kgha_f ,
                TopDress_kgha ,
                TopDress_kgha_f ,
                Index,
                RI,
                SI ,
                GrainYield_Mgha,
                PI_N_Uptake)

paper3_data$Platform <- as.factor(paper3_data$Platform)

str(paper3_data , give.attr = F)

paper3_data <- tibble::rowid_to_column(paper3_data, "ID") #adds a columns with row number.

```

### Calculating Relative Yield

```{r}

nic17 <- subset(paper3_data, site_year == "Nicolaus-17")
nic17 <- apply(nic17,2,max)
nic17max_yield <- as.numeric(nic17[16])

wil17 <- subset(paper3_data, site_year == "Williams-17")
wil17 <- apply(wil17,2,max)
wil17max_yield <- as.numeric(wil17[16])

arb18 <- subset(paper3_data, site_year == "Arbuckle-18")
arb18 <- apply(arb18,2,max)
arb18max_yield <- as.numeric(arb18[16])

nic18 <- subset(paper3_data, site_year == "Nicolaus-18")
nic18 <- apply(nic18,2,max)
nic18max_yield <- as.numeric(nic18[16])

mry18 <- subset(paper3_data, site_year == "Marysville-18")
mry18 <- apply(mry18,2,max)
mry18max_yield <- as.numeric(mry18[16])

biggs18 <- subset(paper3_data, site_year == "Biggs-18")
biggs18 <- apply(biggs18,2,max)
biggs18max_yield <- as.numeric(biggs18[16])

arb19 <- subset(paper3_data, site_year == "Arbuckle-19")
arb19 <- apply(arb19,2,max)
arb19max_yield <- as.numeric(arb19[16])

dav19 <- subset(paper3_data, site_year == "Davis-19")
dav19 <- apply(dav19,2,max)
dav19max_yield <- as.numeric(dav19[16])

mry19 <- subset(paper3_data, site_year == "Marysville-19")
mry19 <- apply(mry19,2,max)
mry19max_yield <- as.numeric(mry19[16])

res19 <- subset(paper3_data, site_year == "RES-19")
res19 <- apply(res19,2,max)
res19max_yield <- as.numeric(res19[16])


paper3_data <- paper3_data %>% 
  mutate(relative_grain_yield = case_when(
                          site_year == "Nicolaus-17" ~ GrainYield_Mgha / nic17max_yield ,
                          site_year == "Williams-17" ~ GrainYield_Mgha / wil17max_yield ,
                          site_year == "Arbuckle-18" ~ GrainYield_Mgha / arb18max_yield ,
                          site_year == "Nicolaus-18" ~ GrainYield_Mgha / nic18max_yield ,
                          site_year == "Marysville-18" ~ GrainYield_Mgha / mry18max_yield ,
                          site_year == "Biggs-18" ~ GrainYield_Mgha / biggs18max_yield,
                          site_year == "Arbuckle-19" ~ GrainYield_Mgha / arb19max_yield ,
                          site_year == "Davis-19" ~ GrainYield_Mgha / dav19max_yield ,
                          site_year == "Marysville-19" ~ GrainYield_Mgha / mry19max_yield ,
                          site_year == "RES-19" ~ GrainYield_Mgha / res19max_yield))


round(tapply(paper3_gsdata$GrainYield_Mgha , paper3_gsdata$site_year , max) , digits = 1)

round((length(which(paper3_uas_ndvi_data$SI > .9)) / length(paper3_uas_ndvi_data$SI)) * 100 , digits = 0)
round((length(which(paper3_uas_ndre_data$SI > .9)) / length(paper3_uas_ndre_data$SI)) * 100 , digits = 0)
round((length(which(paper3_gsdata$SI > .9)) / length(paper3_gsdata$SI)) * 100 , digits = 0)

```

### Outlier Removal
```{r}

filter1 <- paper3_data %>% 
  filter(site_year == "Biggs-18" & exp_plot_number == 101)

paper3_data <- paper3_data %>% 
  filter(!ID %in% filter1$ID) #removes Biggs-18 plot 101 plot bc tractor ran through it

paper3_data$Platform = factor(paper3_data$Platform, levels=c( "GreenSeeker NDVI" ,  "sUAS NDRE" , "sUAS NDVI" ))

paper3_data$RI[paper3_data$RI < 1] <- 1 #converts values less than 1, to 1.
paper3_data$SI[paper3_data$SI > 1] <- 1 #converts values less than 1, to 1.

hist_data <- paper3_data %>% 
  dplyr::select(Platform , RI) %>% 
  group_by(Platform) %>% 
  summarise(mean = mean(RI) , sd = sd(RI) , median = median(RI))

hist_data_gs <- hist_data %>% 
  filter(Platform == "GreenSeeker NDVI")

upper_limit <- hist_data_gs[2] + (5*hist_data_gs[3]) #upper limit for outlier removal. Observations that are 5 sd's away from mean. Observations greater than 3.69 in GreenSeeker. 

print(upper_limit)

#need to remove Arbuckle-18 plot 203 and Arbuckle-19 plot 104

filter1 <- paper3_data %>% 
  filter(site_year == "Arbuckle-18" & exp_plot_number == 203)

filter2 <- paper3_data %>% 
  filter(site_year == "Arbuckle-19" & exp_plot_number == 104)

filter <- rbind(filter1 , filter2)

filter$ID

paper3_data <- paper3_data %>% 
  filter(!ID %in% filter$ID)

paper3_gsdata <- paper3_data %>% 
  filter(Platform == "GreenSeeker NDVI")

paper3_uas_ndvi_data <- paper3_data %>% 
  filter(Platform == "sUAS NDVI")

paper3_uas_ndre_data <- paper3_data %>% 
  filter(Platform == "sUAS NDRE")

ggplot(data = paper3_data , aes ( x = N_level_kgha, y = Index , color = Platform)) +
  geom_point(data = subset(paper3_data , site_year == "Arbuckle-18") , aes( x = N_level_kgha, y = Index , color = Platform))

ggplot(data = suppl_data1_arb18 , aes ( x = N_level_kgha, y = GrainYield_Mgha)) +
  geom_point(data = suppl_data1_arb18 , aes( x = N_level_kgha, y = GrainYield_Mgha)) +
  geom_errorbar(data = suppl_data1_arb18 , aes( x = N_level_kgha, y = GrainYield_Mgha , ymin = GrainYield_Mgha - GrainYield_Mgha_fn2 , ymax = GrainYield_Mgha + GrainYield_Mgha_fn2))

```

## FIGURE 2

### Data

```{r}

suppl_data <- paper3_data

suppl_data1 <- suppl_data %>%
  dplyr::select(site_year, N_level_kgha , TopDress_kgha_f , GrainYield_Mgha , PI_N_Uptake) %>% 
  group_by(site_year , N_level_kgha ,TopDress_kgha_f ) %>% 
  summarise_all(.funs = c(mean , sd)) %>% 
  rename(PI_N_Uptake = PI_N_Uptake_fn1,
         GrainYield_Mgha = GrainYield_Mgha_fn1) %>% 
  mutate(PI_N_Uptake_r = round(PI_N_Uptake , digits = 0),
         GrainYield_Mgha_r = round(GrainYield_Mgha , digits = 1)) %>% 
  ungroup()

factor_list <- list( site = suppl_data1$site_year)

tapply(suppl_data1$GrainYield_Mgha_r, factor_list , max)
tapply(suppl_data1$GrainYield_Mgha_r, factor_list , min)

suppl_data2 <- suppl_data %>%
  dplyr::select(site_year, N_level_kgha , TopDress_kgha_f , Platform , Index) %>% 
  group_by(site_year , N_level_kgha ,TopDress_kgha_f , Platform ) %>% 
  summarise_all(.funs = c(mean , sd)) %>% 
  rename(Index = fn1,
         sd = fn2) %>% 
  ungroup()

ggplot(data = suppl_data2 , aes ( x = N_level_kgha , Index , color = Platform)) +
  geom_point(data = suppl_data2 , aes ( x = N_level_kgha , Index , color = Platform)) +
  coord_cartesian(ylim = c(0.2,1)) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  theme_classic() +
  facet_wrap(~site_year)

```


### Legend

```{r}

suppl_data1_nic17 <- suppl_data1 %>% 
  filter(site_year == "Nicolaus-17")

suppl_data1_nic17_yield <- suppl_data1_nic17 %>% 
  dplyr::select(-c(PI_N_Uptake)) %>% 
  mutate(Legend = as.factor("Final Grain Yield")) %>% 
  rename("Unit" = GrainYield_Mgha)

suppl_data1_nic17_nup <- suppl_data1_nic17 %>% 
  dplyr::select(-c(GrainYield_Mgha)) %>% 
  mutate(Legend = as.factor("PI Total N Uptake")) %>% 
  rename("Unit" = PI_N_Uptake)

suppl_data1_nic17 <- rbind(suppl_data1_nic17_nup , suppl_data1_nic17_yield)

nic17_plot_legend <- ggplot(data = suppl_data1_nic17 , aes( x = N_level_kgha , y = Unit , color = Legend , linetype = Legend)) +
  geom_point(data = suppl_data1_nic17 , aes ( x = N_level_kgha , y = Unit , color = Legend) , size = 5) +
  scale_y_continuous(breaks = seq(0 , 300 , by = 50)) +
  coord_cartesian(ylim = c(0 , 300)) +
  theme_classic() +
  theme(legend.text = element_text(size = 28 ),
        legend.title = element_text(size = 28 ),
        legend.box.background = element_rect(size = 1)) +
  annotate("text" , x = 190 , y = 0 , label = "Nicolaus-17" , size = 6) +
  labs( x = NULL , y = NULL) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  guides(size = "none" , color = guide_legend(keywidth = 5 , keyheight = 1.5 , unit = "cm" , override.aes = list(size = 3) , title.hjust = 0.5))

nic17_plot_legend

legend <- get_legend(nic17_plot_legend)

```

### Nicolaus-17

```{r}

suppl_data1_nic17 <- suppl_data1 %>% 
  filter(site_year == "Nicolaus-17")

nic17_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_nic17)

nic17_fitted <- fitted(nic17_nuptake_lm)
nic17_df <- data.frame(suppl_data1_nic17$N_level_kgha , nic17_fitted) #creates dataframe

nic17_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_nic17)

nic17_fitted_2 <- (fitted(nic17_yield_lm)*23)
nic17_df_2 <- data.frame(suppl_data1_nic17$N_level_kgha , nic17_fitted_2) #creates dataframe

nic17_plot <- ggplot(data = suppl_data1_nic17 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_nic17 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_nic17 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = nic17_df , aes( x = suppl_data1_nic17.N_level_kgha , y = nic17_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = nic17_df_2 , aes( x = suppl_data1_nic17.N_level_kgha , y = nic17_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 22),
        axis.text.y.right = element_blank(),
        axis.text.x = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Nicolaus-17" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

nic17_plot

```


### Williams-17

```{r}

suppl_data1_wil17 <- suppl_data1 %>% 
  filter(site_year == "Williams-17")

wil17_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_wil17)

wil17_fitted <- fitted(wil17_nuptake_lm)
wil17_df <- data.frame(suppl_data1_wil17$N_level_kgha , wil17_fitted) #creates dataframe

wil17_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_wil17)

wil17_fitted_2 <- (fitted(wil17_yield_lm)*23)
wil17_df_2 <- data.frame(suppl_data1_wil17$N_level_kgha , wil17_fitted_2) #creates dataframe

wil17_plot <- ggplot(data = suppl_data1_wil17 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_wil17 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_wil17 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = wil17_df , aes( x = suppl_data1_wil17.N_level_kgha , y = wil17_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = wil17_df_2 , aes( x = suppl_data1_wil17.N_level_kgha , y = wil17_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Williams-17" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

wil17_plot


```

### Arbuckle-18

```{r}

suppl_data1_arb18 <- suppl_data1 %>% 
  filter(site_year == "Arbuckle-18")

arb18_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_arb18)

arb18_fitted <- fitted(arb18_nuptake_lm)
arb18_df <- data.frame(suppl_data1_arb18$N_level_kgha , arb18_fitted) #creates dataframe

arb18_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_arb18)

arb18_fitted_2 <- (fitted(arb18_yield_lm)*23)
arb18_df_2 <- data.frame(suppl_data1_arb18$N_level_kgha , arb18_fitted_2) #creates dataframe

arb18_plot <- ggplot(data = suppl_data1_arb18 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_arb18 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_arb18 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = arb18_df , aes( x = suppl_data1_arb18.N_level_kgha , y = arb18_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = arb18_df_2 , aes( x = suppl_data1_arb18.N_level_kgha , y = arb18_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Arbuckle-18" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

arb18_plot

```

### Biggs-18

```{r}

suppl_data1_biggs18 <- suppl_data1 %>% 
  filter(site_year == "Biggs-18" )

biggs18_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_biggs18)

biggs18_fitted <- fitted(biggs18_nuptake_lm)
biggs18_df <- data.frame(suppl_data1_biggs18$N_level_kgha , biggs18_fitted) #creates dataframe

biggs18_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_biggs18)

biggs18_fitted_2 <- (fitted(biggs18_yield_lm)*23)
biggs18_df_2 <- data.frame(suppl_data1_biggs18$N_level_kgha , biggs18_fitted_2) #creates dataframe

biggs18_plot <- ggplot(data = suppl_data1_biggs18 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_biggs18 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_biggs18 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = biggs18_df , aes( x = suppl_data1_biggs18.N_level_kgha , y = biggs18_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = biggs18_df_2 , aes( x = suppl_data1_biggs18.N_level_kgha , y = biggs18_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Biggs-18" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

biggs18_plot

```

### Marysville-18

```{r}

suppl_data1_mry18 <- suppl_data1 %>% 
  filter(site_year == "Marysville-18" )

mry18_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_mry18)

mry18_fitted <- fitted(mry18_nuptake_lm)
mry18_df <- data.frame(suppl_data1_mry18$N_level_kgha , mry18_fitted) #creates dataframe

mry18_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_mry18)

mry18_fitted_2 <- (fitted(mry18_yield_lm)*23)
mry18_df_2 <- data.frame(suppl_data1_mry18$N_level_kgha , mry18_fitted_2) #creates dataframe

mry18_plot <- ggplot(data = suppl_data1_mry18 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_mry18 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_mry18 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = mry18_df , aes( x = suppl_data1_mry18.N_level_kgha , y = mry18_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = mry18_df_2 , aes( x = suppl_data1_mry18.N_level_kgha , y = mry18_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y.right = element_text(size = 22),
        axis.text.y.left = element_blank(),
        axis.text.x = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Marysville-18" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

mry18_plot


```

### Nicolaus-18

```{r}

suppl_data1_nic18 <- suppl_data1 %>% 
  filter(site_year == "Nicolaus-18" )

nic18_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_nic18)

nic18_fitted <- fitted(nic18_nuptake_lm)
nic18_df <- data.frame(suppl_data1_nic18$N_level_kgha , nic18_fitted) #creates dataframe

nic18_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_nic18)

nic18_fitted_2 <- (fitted(nic18_yield_lm)*23)
nic18_df_2 <- data.frame(suppl_data1_nic18$N_level_kgha , nic18_fitted_2) #creates dataframe

nic18_plot <- ggplot(data = suppl_data1_nic18 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_nic18 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_nic18 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = nic18_df , aes( x = suppl_data1_nic18.N_level_kgha , y = nic18_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = nic18_df_2 , aes( x = suppl_data1_nic18.N_level_kgha , y = nic18_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y.right = element_blank(),
        axis.text.x = element_text(size = 22),
        axis.text.y.left = element_text(size = 22)) +
  annotate("text" , x = 250 , y = 0 , label = "Nicolaus-18" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

nic18_plot



```

### Arbuckle-19

```{r}

suppl_data1_arb19 <- suppl_data1 %>% 
  filter(site_year == "Arbuckle-19" )

arb19_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_arb19)

arb19_fitted <- fitted(arb19_nuptake_lm)
arb19_df <- data.frame(suppl_data1_arb19$N_level_kgha , arb19_fitted) #creates dataframe

arb19_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_arb19)

arb19_fitted_2 <- (fitted(arb19_yield_lm)*23)
arb19_df_2 <- data.frame(suppl_data1_arb19$N_level_kgha , arb19_fitted_2) #creates dataframe

arb19_plot <- ggplot(data = suppl_data1_arb19 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_arb19 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_arb19 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = arb19_df , aes( x = suppl_data1_arb19.N_level_kgha , y = arb19_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = arb19_df_2 , aes( x = suppl_data1_arb19.N_level_kgha , y = arb19_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 22)) +
  annotate("text" , x = 250 , y = 0 , label = "Arbuckle-19" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

arb19_plot

```

### Davis-19

```{r}

suppl_data1_davis19 <- suppl_data1 %>% 
  filter(site_year == "Davis-19" )

davis19_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_davis19)

davis19_fitted <- fitted(davis19_nuptake_lm)
davis19_df <- data.frame(suppl_data1_davis19$N_level_kgha , davis19_fitted) #creates dataframe

davis19_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_davis19)

davis19_fitted_2 <- (fitted(davis19_yield_lm)*23)
davis19_df_2 <- data.frame(suppl_data1_davis19$N_level_kgha , davis19_fitted_2) #creates dataframe

davis19_plot <- ggplot(data = suppl_data1_davis19 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_davis19 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_davis19 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = davis19_df , aes( x = suppl_data1_davis19.N_level_kgha , y = davis19_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = davis19_df_2 , aes( x = suppl_data1_davis19.N_level_kgha , y = davis19_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(size = 22))+
  annotate("text" , x = 250 , y = 0 , label = "Davis-19" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

davis19_plot

```

### Marysville-19

```{r}

suppl_data1_mry19 <- suppl_data1 %>% 
  filter(site_year == "Marysville-19" )

mry19_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_mry19)

mry19_fitted <- fitted(mry19_nuptake_lm)
mry19_df <- data.frame(suppl_data1_mry19$N_level_kgha , mry19_fitted) #creates dataframe

mry19_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_mry19)

mry19_fitted_2 <- (fitted(mry19_yield_lm)*23)
mry19_df_2 <- data.frame(suppl_data1_mry19$N_level_kgha , mry19_fitted_2) #creates dataframe

mry19_plot <- ggplot(data = suppl_data1_mry19 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_mry19 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_mry19 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = mry19_df , aes( x = suppl_data1_mry19.N_level_kgha , y = mry19_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = mry19_df_2 , aes( x = suppl_data1_mry19.N_level_kgha , y = mry19_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
    scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 22),
        axis.text.y = element_blank()) +
  annotate("text" , x = 250 , y = 0 , label = "Marysville-19" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

mry19_plot

```

### RES-19

```{r}

suppl_data1_res19 <- suppl_data1 %>% 
  filter(site_year == "RES-19" )

res19_nuptake_lm <- lm(PI_N_Uptake ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_res19)

res19_fitted <- fitted(res19_nuptake_lm)
res19_df <- data.frame(suppl_data1_res19$N_level_kgha , res19_fitted) #creates dataframe

res19_yield_lm <- lm(GrainYield_Mgha ~ N_level_kgha + I(N_level_kgha*N_level_kgha) , data = suppl_data1_res19)

res19_fitted_2 <- (fitted(res19_yield_lm)*23)
res19_df_2 <- data.frame(suppl_data1_res19$N_level_kgha , res19_fitted_2) #creates dataframe

res19_plot <- ggplot(data = suppl_data1_res19 , aes( x = N_level_kgha , y = PI_N_Uptake)) +
  geom_point(data = suppl_data1_res19 , aes ( x = N_level_kgha , y = PI_N_Uptake) , color = "#F8766D" , size = 5) +
  geom_point(data = suppl_data1_res19 , aes ( x = N_level_kgha , y = GrainYield_Mgha*23) , color = "#00BFC4" , size = 5) +
  geom_line(data = res19_df , aes( x = suppl_data1_res19.N_level_kgha , y = res19_fitted) , color = "#F8766D" , size = 1.5) +
  geom_line(data = res19_df_2 , aes( x = suppl_data1_res19.N_level_kgha , y = res19_fitted_2) , color = "#00BFC4" , size = 1.5 , linetype = "dashed") +
  scale_y_continuous(breaks = seq(0 , 300 , by = 100) , sec.axis = sec_axis(~./23  , breaks = seq(0 , 16 , by = 3))) +
  coord_cartesian(ylim = c(0 , 300) , xlim = c(0 , 250)) +
  scale_x_continuous(breaks = seq(0 , 280 , by = 100)) +
  theme_classic() +
  theme(axis.text.y.left = element_blank(),
        axis.text.x = element_text(size = 22),
        axis.text.y.right = element_text(size = 22)) +
  annotate("text" , x = 250 , y = 0 , label = "RES-19" , size = 7 , hjust = 1) +
  labs( x = NULL , y = NULL)
  

res19_plot

```

### FIGURE 2

```{r}

Fig2 <- grid.arrange(arrangeGrob(
                              nic17_plot,
                              wil17_plot,
                              arb18_plot,
                              biggs18_plot,
                              mry18_plot,
                              nic18_plot,
                              arb19_plot,
                              davis19_plot,
                              mry19_plot,
                              res19_plot,
                              ncol = 5,
                              nrow = 2 ,
                              widths = c(1.4, 1.2 , 1.2, 1.2,  1.3 ),
                              bottom = textGrob("Pre-plant N Rate ( kg N ha"^-1~")" ,
                                                gp = gpar( fontsize = 30)),
                              right = textGrob("Mean Final Grain Yield ( Mg ha"^-1~")" ,
                                              gp = gpar(fontsize = 30) ,
                                              rot = 270),
                              left = textGrob("Mean PI Total N Uptake ( kg N ha"^-1~")" ,
                                              gp = gpar( fontsize = 30) ,
                                              rot = 90)
                              ))


Fig2 <- grid.arrange(arrangeGrob(Fig2,
                                 legend,
                                 ncol = 1,
                                 nrow = 2,
                                 heights = c(8 , 1.5)))

ggsave("FIGURES/Fig2.tiff" , Fig2, compression = "lzw" , width = 22 , height = 12 , type = "cairo" , dpi = 500)

```

## FIGURE 3
```{r}

fit.lm1    <- lm(GrainYield_Mgha ~ PI_N_Uptake, data= paper3_gsdata)

a.ini1     <- fit.lm1$coefficients[1]
b.ini1     <- fit.lm1$coefficients[2]
clx.ini1   <- mean(paper3_gsdata$PI_N_Uptake)

quadplat <- function(x, a, b, clx) {
           ifelse(x  < clx, a + b * x   + (-0.5*b/clx) * x   * x,
                            a + b * clx + (-0.5*b/clx) * clx * clx)}

model1 <- nls(GrainYield_Mgha ~ quadplat(PI_N_Uptake, a, b, clx),
            data = paper3_gsdata,
            start = list(a   = a.ini1,
                         b   = b.ini1,
                         clx = clx.ini1),
             trace = FALSE,
             nls.control(maxiter = 1000))


quadratic.plateau <- function(x, a, b, c)
  {
    ifelse(x < -b/(2 * c), 
           a + b*x + c*x*x,
           a - b^2/(4 * c))
  }

model1 <- nlme(SI ~ quadratic.plateau(PI_N_Uptake,a,b,c), 
                   fixed = list(a ~ 1, b ~ 1, c ~ 1),
                   random = I(a + b + c) ~ 1|Site_Year,
                   start=list(a = a.ini1,
                              b = b.ini1,
                              c = clx.ini1),
                   weights=varIdent(form=~1|Site_Year),
                   data = Data,
                   method = "ML")

summary(model1)

nullfunct <- function(x, m){m}

m.ini1    <- mean(paper3_gsdata$PI_N_Uptake)

null1 <- nls(GrainYield_Mgha ~ nullfunct(PI_N_Uptake, m),
           data = paper3_gsdata,
           start = list(m   = m.ini1),
           trace = FALSE,
           nls.control(maxiter = 1000))

nagelkerke(model1,
           null1)

confint2(model1,
         level = 0.95)

Boot1 <- nlsBoot(model1)

summary(Boot1)

plotPredy(data  = paper3_gsdata,
          x     = PI_N_Uptake,
          y     = GrainYield_Mgha,
          model = model1,
          xlab  = "PI Total N Uptake",
          ylab  = "Final Grain Yield")

x1 <- residuals(model1)

plotNormalHistogram(x1)

plot(fitted(model1),
     residuals(model1))

a1 <- summary(model1)$coefficients[1]
b1 <- summary(model1)$coefficients[2]
clx1 <- summary(model1)$coefficients[3]

plateau1 <- a1 + b1 * clx1
plateau1

pinup_yield_fit_linplat <- fitted(model1)
pinup_yield_fit_linplat_df <- data.frame(paper3_gsdata$PI_N_Uptake , pinup_yield_fit_linplat) #creates dataframe

ggplot(data = paper3_gsdata , aes(x = PI_N_Uptake , y = GrainYield_Mgha)) +
  geom_point(data = paper3_gsdata , aes(x = PI_N_Uptake , y = GrainYield_Mgha))

```

### FIGURE 3
```{r}

pinup_yield_lin_plot <- ggplot(data = paper3_gsdata , aes ( x = PI_N_Uptake , y = GrainYield_Mgha)) +
  geom_point(data = paper3_gsdata , aes ( x = PI_N_Uptake , y = GrainYield_Mgha , shape = site_year) , size = 5) +
  geom_line(data = pinup_yield_fit_linplat_df , aes( x = paper3_gsdata.PI_N_Uptake , y = pinup_yield_fit_linplat) , size = 3 , color = "blue") +
  coord_cartesian(ylim = c(2 , 14) , xlim = c(0 , 252)) +
  scale_x_continuous(breaks = seq(0 , 250 , by = 50)) +
  scale_y_continuous(breaks = seq(2 , 14 , by = 2)) +
  theme_classic() +
  labs(x = "PI Total N Uptake ( kg N ha"^-1~")" , y = "Final Grain Yield ( Mg ha"^-1~")" , shape = "Site-Year") +
  annotate("text", x = 190 , y = 2, label = "plateau~'='~94~kg~N~ha^-1", size = 8 , color = "black" , parse = T , hjust = .5) +
  annotate("text", x = 190 , y = 2.5, label = "R² = 0.62", size = 8 , color = "black"  , hjust = .5) +
  theme(axis.title = element_text(size = 26),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18 , hjust = 0.5),
        legend.box.background = element_rect(size = 1)
        ) +
  geom_hline(yintercept = 0 , size = 0.75) +
  theme(legend.position = c(0.75 , 0.30)) +
  scale_shape_manual(values = c(1:20))

pinup_yield_lin_plot


ggsave("FIGURES/Fig1.5.tiff" , pinup_yield_lin_plot, compression = "lzw" , width = 17 , height = 12 , type = "cairo" , dpi = 500)

```

## FIGURE 4

### IV Kernel

```{r}

Fig3.1 <- ggplot(data = paper3_data , aes(x = Index) ) +
  geom_density(data = paper3_data, aes(x = Index  , color = Platform , linetype = Platform) , size = 1.5) +
  geom_rug(data = paper3_data , aes(x = Index  , color = Platform) , size = 1.2) +
  theme_classic() +
  theme(axis.title = element_text(size = 32),
        axis.text = element_text(size = 28),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24 , hjust = 0.5),
        legend.position = c(.15 , .75),
        legend.text.align = 0,
        legend.box.background = element_rect(size = 1)) +
  coord_cartesian(xlim = c(0.2 , 0.95)  ,ylim = c(0 , 18)) +
  scale_x_continuous(breaks = seq(.2 , .9 , by = .1)) +
  scale_y_continuous(breaks = seq(0 , 18 , by = 3)) +
  labs(x = "Raw Index Value" , y = "Density" , color = "Index" , linetype = "Index") +
  scale_color_manual(breaks = c("sUAS NDVI" , "GreenSeeker NDVI" ,  "sUAS NDRE") , values = c( "dodgerblue" , "black" , "deeppink") , labels = c(expression(NDVI[UAS]) , expression(NDVI[GS]) , expression(NDRE[UAS]))) +
  scale_linetype_manual(breaks = c("sUAS NDVI" , "GreenSeeker NDVI" ,  "sUAS NDRE") , values = c("longdash" , "solid" ,  "dotted") , labels = c(expression(NDVI[UAS]) , expression(NDVI[GS]) , expression(NDRE[UAS]))) +
    guides(
    color = guide_legend(byrow = TRUE)
  ) +
  theme(
        legend.spacing.y = unit(0.4, "cm")) +
  annotate("text" , x = (0.2) , y = (18) , label = "(a)" , size = 10 , hjust = 0.5 , fontface = 2)
  

Fig3.1

ggsave("FIGURES/Fig3.1.tiff" , Fig3.1 , compression = "lzw" , width = 15 , height = 10, type = "cairo" , dpi = 500)

```

### SI Kernel

```{r}



Fig3.2 <- ggplot(data = paper3_data , aes(x = SI) ) +
  geom_density(data = paper3_data, aes(x = SI  , color = Platform , linetype = Platform) , size = 1.5) +
  geom_rug(data = paper3_data , aes(x = SI  , color = Platform) , size = 1.2) +
  theme_classic() +
  theme(axis.title = element_text(size = 32),
        axis.text = element_text(size = 28),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24),
        legend.position = c(0.22 , 0.87)
        ) +
  coord_cartesian(xlim = c(.3 , 1) , ylim = c(0 , 18)) +
  scale_x_continuous(breaks = seq(.3 , 1 , by = .1)) +
  scale_y_continuous(breaks = seq(0 , 18 , by = 3)) +
  labs(x = "Sufficiency Index" , y = "Density" , color = "Index" , linetype = "Index") +
  scale_color_manual(breaks = c("sUAS NDVI" , "GreenSeeker NDVI" ,  "sUAS NDRE") , values = c( "dodgerblue" , "black" , "deeppink") , labels = c(expression(NDVI[UAS]) , expression(NDVI[GS]) , expression(NDRE[UAS]))) +
  scale_linetype_manual(breaks = c("sUAS NDVI" , "GreenSeeker NDVI" ,  "sUAS NDRE") , values = c("longdash" , "solid" ,  "dotted") , labels = c(expression(NDVI[UAS]) , expression(NDVI[GS]) , expression(NDRE[UAS]))) +
    guides(
    color = guide_legend(byrow = TRUE)
  ) +
  theme(
        legend.spacing.y = unit(0.5, "cm")) +
  annotate("text" , x = (0.3) , y = (18) , label = "(b)" , size = 10 , hjust = 0.5 , fontface = 2)
  

Fig3.2

ggsave("FIGURES/Fig3.2.tiff" , Fig3.2 , compression = "lzw" , width = 15 , height = 10, type = "cairo" , dpi = 500)

Fig3.2.2 <- Fig3.2 +
  labs(x = "Sufficiency Index" , y = NULL , color = "Index" , linetype = "Index") +
    theme(axis.title = element_text(size = 32),
        axis.text = element_text(size = 28),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24),
        legend.position = "none"
        )
  
```


### FIGURE 4
```{r}

Fig3 <- grid.arrange(arrangeGrob(Fig3.1,
                                  Fig3.2.2,
                                  nrow = 1,
                                  ncol = 2
                                  ))

ggsave("FIGURES/Fig3.tiff" , Fig3 , compression = "lzw" , width = 20 , height = 10, type = "cairo" , dpi = 750)


```

## FIGURE 5

### gs-ndvi-SI

```{r}

fit.lm    <- lm(SI ~ PI_N_Uptake, data= paper3_gsdata)

a.ini     <- fit.lm$coefficients[1]
b.ini     <- fit.lm$coefficients[2]
clx.ini   <- mean(paper3_gsdata$PI_N_Uptake)

quadplat <- function(x, a, b, clx) {
           ifelse(x  < clx, a + b * x   + (-0.5*b/clx) * x   * x,
                            a + b * clx + (-0.5*b/clx) * clx * clx)}

model <- nls(SI ~ quadplat(PI_N_Uptake, a, b, clx),
            data = paper3_gsdata,
            start = list(a   = a.ini,
                         b   = b.ini,
                         clx = clx.ini),
             trace = FALSE,
             nls.control(maxiter = 1000))

summary(model)

nullfunct <- function(x, m){m}

m.ini    <- mean(paper3_gsdata$SI)

null <- nls(SI ~ nullfunct(PI_N_Uptake, m),
           data = paper3_gsdata,
           start = list(m   = m.ini),
           trace = FALSE,
           nls.control(maxiter = 1000))

nagelkerke(model,
           null)

confint2(model,
         level = 0.95)

Boot <- nlsBoot(model)

summary(Boot)

plotPredy(data  = paper3_gsdata,
          x     = PI_N_Uptake,
          y     = SI,
          model = model,
          xlab  = "PI Total N Uptake",
          ylab  = "GreenSeeker NDVI SI")

x <- residuals(model)

plotNormalHistogram(x)

plot(fitted(model),
     residuals(model))

a <- summary(model)$coefficients[1]
b <- summary(model)$coefficients[2]
clx <- summary(model)$coefficients[3]

plateau <- a + b * clx + (-0.5*b)*clx
plateau

GS_ndvi_fit_quadplat <- fitted(model)
GS_ndvi_quadplat_df <- data.frame(paper3_gsdata$PI_N_Uptake , GS_ndvi_fit_quadplat) #creates dataframe

```

```{r}


GS_ndvi_si_quad_plot <- ggplot(data = paper3_gsdata , aes ( x = PI_N_Uptake , y = SI)) +
  geom_point(data = paper3_gsdata , aes ( x = PI_N_Uptake , y = SI , shape = site_year) , size = 5) +
  geom_line(data = GS_ndvi_quadplat_df , aes( x = paper3_gsdata.PI_N_Uptake , y = GS_ndvi_fit_quadplat) , size = 3 , color = "blue") +
  coord_cartesian(ylim = c(0.20 , 1) , xlim = c(0 , 252)) +
  scale_x_continuous(breaks = seq(0 , 250 , by = 50)) +
  theme_classic() +
  labs(x = NULL , y = NULL) +
  annotate("text", x = 0 , y = 1, label = "(a)", size = 10 , color = "black" , hjust = .5 , fontface = 2) +
  annotate("text", x = 190 , y = .29, label = "NDVI[GS]", size = 9 , color = "black" , hjust = .5 , parse = T) +
  annotate("text", x = 190 , y = .25, label = "plateau~'='~113~kg~N~ha^-1", size = 8 , color = "black" , parse = T , hjust = .5) +
  annotate("text", x = 190 , y = .21, label = "R² = 0.73", size = 8 , color = "black"  , hjust = .5) +
  theme(axis.title = element_text(size = 26),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24)
        ) +
  geom_hline(yintercept = 0 , size = 0.75) +
  theme(legend.position = "none") +
  scale_shape_manual(values = c(1:20))

GS_ndvi_si_quad_plot

```

### suas-ndre-SI

```{r}

fit.lm2    <- lm(SI ~ PI_N_Uptake, data= paper3_uas_ndre_data)

a.ini2     <- fit.lm2$coefficients[1]
b.ini2     <- fit.lm2$coefficients[2]
clx.ini2   <- mean(paper3_uas_ndre_data$PI_N_Uptake)

quadplat <- function(x, a, b, clx) {
           ifelse(x  < clx, a + b * x   + (-0.5*b/clx) * x   * x,
                            a + b * clx + (-0.5*b/clx) * clx * clx)}

model2 <- nls(SI ~ quadplat(PI_N_Uptake, a, b, clx),
            data = paper3_uas_ndre_data,
            start = list(a   = a.ini2,
                         b   = b.ini2,
                         clx = clx.ini2),
             trace = FALSE,
             nls.control(maxiter = 1000))

summary(model2)

nullfunct <- function(x, m){m}

m.ini2    <- mean(paper3_uas_ndre_data$SI)

null2 <- nls(SI ~ nullfunct(PI_N_Uptake, m),
           data = paper3_uas_ndre_data,
           start = list(m   = m.ini2),
           trace = FALSE,
           nls.control(maxiter = 1000))

nagelkerke(model2,
           null2)

confint2(model2,
         level = 0.95)

Boot2 <- nlsBoot(model2)

summary(Boot2)

plotPredy(data  = paper3_uas_ndre_data,
          x     = PI_N_Uptake,
          y     = SI,
          model = model2,
          xlab  = "PI Total N Uptake",
          ylab  = "sUAS NDRE SI")

a2 <- summary(model2)$coefficients[1]
b2 <- summary(model2)$coefficients[2]
clx2 <- summary(model2)$coefficients[3]

plateau2 <- a2 + b2 * clx2 + (-0.5*b2)*clx2
plateau2

sUAS_ndre_fit_quadplat <- fitted(model2)
sUAS_ndre_quadplat_df <- data.frame(paper3_uas_ndre_data$PI_N_Uptake , sUAS_ndre_fit_quadplat) #creates dataframe

```


```{r}


suas_ndre_si_quad_plot <- ggplot(data = paper3_uas_ndre_data , aes ( x = PI_N_Uptake , y = SI)) +
  geom_point(data = paper3_uas_ndre_data , aes ( x = PI_N_Uptake , y = SI , shape = site_year) , size = 5) +
  geom_line(data = sUAS_ndre_quadplat_df , aes( x = paper3_uas_ndre_data.PI_N_Uptake , y = sUAS_ndre_fit_quadplat) , size = 3 , color = "blue") +
  coord_cartesian(ylim = c(0.20 , 1) , xlim = c(0 , 252)) +
  scale_x_continuous(breaks = seq(0 , 250 , by = 50)) +
  theme_classic() +
  labs(x = NULL , y = NULL) +
  annotate("text", x = 0 , y = 1, label = "(b)", size = 10 , color = "black" , hjust = 0.5 , fontface = 2) +
  annotate("text", x = 190 , y = .29, label = "NDRE[UAS]", size = 9 , color = "black" , hjust = .5 , parse = T) +
  annotate("text", x = 190 , y = .25, label = "plateau~'='~129~kg~N~ha^-1", size = 8 , color = "black" , parse = T , hjust = .5) +
  annotate("text", x = 190 , y = .21, label = "R² = 0.80", size = 8 , color = "black"  , hjust = .5) +
  theme(axis.title = element_text(size = 26),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24)
        ) +
  geom_hline(yintercept = 0 , size = 0.75) +
  theme(legend.position = "none") +
  scale_shape_manual(values = c(1:20))

suas_ndre_si_quad_plot

```

### suas-ndvi-SI

```{r}

fit.lm3    <- lm(SI ~ PI_N_Uptake, data= paper3_uas_ndvi_data)

a.ini3     <- fit.lm3$coefficients[1]
b.ini3     <- fit.lm3$coefficients[2]
clx.ini3   <- mean(paper3_uas_ndvi_data$PI_N_Uptake)

quadplat <- function(x, a, b, clx) {
           ifelse(x  < clx, a + b * x   + (-0.5*b/clx) * x   * x,
                            a + b * clx + (-0.5*b/clx) * clx * clx)}

model3 <- nls(SI ~ quadplat(PI_N_Uptake, a, b, clx),
            data = paper3_uas_ndvi_data,
            start = list(a   = a.ini3,
                         b   = b.ini3,
                         clx = clx.ini3),
             trace = FALSE,
             nls.control(maxiter = 1000))

summary(model3)

nullfunct <- function(x, m){m}

m.ini3    <- mean(paper3_uas_ndvi_data$SI)

null3 <- nls(SI ~ nullfunct(PI_N_Uptake, m),
           data = paper3_uas_ndvi_data,
           start = list(m   = m.ini3),
           trace = FALSE,
           nls.control(maxiter = 1000))

nagelkerke(model3,
           null3)

confint2(model3,
         level = 0.95)

Boot3 <- nlsBoot(model3)

summary(Boot3)

plotPredy(data  = paper3_uas_ndvi_data,
          x     = PI_N_Uptake,
          y     = SI,
          model = model3,
          xlab  = "PI Total N Uptake",
          ylab  = "sUAS NDVI SI")

a3 <- summary(model3)$coefficients[1]
b3 <- summary(model3)$coefficients[2]
clx3 <- summary(model3)$coefficients[3]

plateau3 <- a3 + b3 * clx3 + (-0.5*b3)*clx3
plateau3

sUAS_ndvi_fit_quadplat <- fitted(model3)
sUAS_ndvi_quadplat_df <- data.frame(paper3_uas_ndvi_data$PI_N_Uptake , sUAS_ndvi_fit_quadplat) #creates dataframe


```

```{r}

suas_ndvi_si_quad_plot <- ggplot(data = paper3_uas_ndvi_data , aes ( x = PI_N_Uptake , y = SI)) +
  geom_point(data = paper3_uas_ndvi_data , aes ( x = PI_N_Uptake , y = SI , shape = site_year) , size = 5) +
  geom_line(data = sUAS_ndvi_quadplat_df , aes( x = paper3_uas_ndvi_data.PI_N_Uptake , y = sUAS_ndvi_fit_quadplat) , size = 3 , color = "blue") +
  coord_cartesian(ylim = c(0.20 , 1) , xlim = c(0 , 252)) +
  scale_x_continuous(breaks = seq(0 , 250 , by = 50)) +
  theme_classic() +
  labs(x = NULL , y = NULL , shape = "Site-Year") +
  annotate("text", x = 0 , y = 1, label = "(c)", size = 10 , color = "black" , hjust = 0.5 , fontface = 2) +
  annotate("text", x = 190 , y = .29, label = "NDVI[UAS]", size = 9 , color = "black" , hjust = .5 , parse = T) +
  annotate("text", x = 190 , y = .25, label = "plateau~'='~96~kg~N~ha^-1", size = 8 , color = "black" , parse = T , hjust = .5) +
  annotate("text", x = 190 , y = .21, label = "R² = 0.81", size = 8 , color = "black"  , hjust = .5) +
  theme(axis.title = element_text(size = 26),
        axis.text = element_text(size = 26),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20 , hjust = 0.5),
        legend.box.background = element_rect(size = 1)) +
  geom_hline(yintercept = 0 , size = 0.75) +
  theme(legend.position = c(.72 , .4)) +
  scale_shape_manual(values = c(1:20))

suas_ndvi_si_quad_plot


```

### FIGURE 5
```{r}

Fig4 <- grid.arrange(arrangeGrob(GS_ndvi_si_quad_plot,
                                          suas_ndre_si_quad_plot,
                                          suas_ndvi_si_quad_plot,
                                          left = textGrob("Sufficiency Index" , rot = 90 , gp = gpar(fontsize = 32)),
                                  bottom = textGrob("PI Total N Uptake ( kg N ha"^-1~")" , gp = gpar(fontsize = 32)),
                                  nrow = 1,
                                  ncol = 3
                                  ))

ggsave("FIGURES/Fig4.tiff" , Fig4 , compression = "lzw" , width = 22 , height = 10, type = "cairo" , dpi = 750)


```

## FIGURE 6

### gs ndvi SI

#### model

```{r}

ctrl <- lmeControl(opt = "optim") #changes control to "optimal" settings

gsndvi_yield_mixlm <- lme(fixed = GrainYield_Mgha ~ SI ,
                          random = ~I(SI) | site_year,
                          data = paper3_gsdata)

summary(gsndvi_yield_mixlm)

summary(gsndvi_yield_mixlm)$tTable

Anova(gsndvi_yield_mixlm , type = 2)
Anova(gsndvi_yield_mixlm , type = 3)

r.squaredGLMM(gsndvi_yield_mixlm)

```

#### diagnostics

```{r}

plot (gsndvi_yield_mixlm)

plot(resid(gsndvi_yield_mixlm, type = "normalized") ~fitted(gsndvi_yield_mixlm))

gsndvi_yield_mixlm_y <- resid(gsndvi_yield_mixlm, type = "normalized")
gsndvi_yield_mixlm_x <- fitted(gsndvi_yield_mixlm)

gsndvi_yield_mixlmresid_data <- data.frame(gsndvi_yield_mixlm_x , gsndvi_yield_mixlm_y)

ggplot( data = gsndvi_yield_mixlmresid_data , aes( x = gsndvi_yield_mixlm_x , y = gsndvi_yield_mixlm_y)) +
  geom_point(mapping = aes(gsndvi_yield_mixlm_x , gsndvi_yield_mixlm_y) , data = gsndvi_yield_mixlmresid_data)

hist(resid(gsndvi_yield_mixlm))


plot(gsndvi_yield_mixlm, site_year ~ resid(.), abline = 0)


qqnorm(gsndvi_yield_mixlm, abline = c(0,1) )


qqnorm(resid(gsndvi_yield_mixlm))
qqline(resid(gsndvi_yield_mixlm))


qqnorm(gsndvi_yield_mixlm , ~resid(.) | site_year)

plot(ranef(gsndvi_yield_mixlm))

pairs(gsndvi_yield_mixlm , id = 0.1) 

qqnorm(gsndvi_yield_mixlm , ~ranef(.))

plot( gsndvi_yield_mixlm, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

#### emmeans

```{r}

mylist <- list(SI=seq(round(min(paper3_gsdata$SI), digits = 3) , 1 , by = .001))

gsndvi_emmeans <- as.data.frame(summary(emmeans(gsndvi_yield_mixlm , ~ SI , at = mylist )))

```

#### plot

```{r}

plot_si1 <- ggplot( data = paper3_gsdata , aes( x = SI , y = GrainYield_Mgha)) +
  geom_point( data = paper3_gsdata , aes( x = SI , y = GrainYield_Mgha , shape = site_year) , size = 7) +
  geom_line( data = gsndvi_emmeans , aes(x = SI , y = emmean) , color = "blue" , size = 3.5) +
  theme_classic() +
  labs( x = NULL , y = NULL , color = "Index") +
  scale_x_continuous(breaks = seq(.2 , 1 , by = .1)) +
  scale_y_continuous(breaks = seq(0 , 14 , by = 2)) +
  coord_cartesian(ylim = c(0,14) , xlim = c(.27 , 1)) +
  geom_vline(xintercept = 1 , size = 0.75) +
  theme(axis.text = element_text(size = 38),
        axis.title = element_text(size = 38),
        legend.text = element_text(size = 24),
        legend.title = element_text(size = 24),
        legend.position = "none") +
  annotate("text", x=0.26, y=11, label="R² = 0.53\np < 0.001\nslope = 9.5", size = 10 , color = "black" , hjust = 0) +
  annotate("text", x=0.26, y=14.1, label="(a)", size = 10 , color = "black" , hjust = 0 , fontface = 2) +
  annotate("text", x=0.285, y=14, label="NDVI[GS]", size = 10 , color = "black" , hjust = 0 , parse = T) +
  scale_shape_manual(values = c(1:20))

plot_si1

```

### sUAS ndvi RI

#### model

```{r}

sUASndvi_yield_mixlm <- lme(fixed = GrainYield_Mgha ~ SI ,
                          random = ~I(SI) | site_year,
                          data = paper3_uas_ndvi_data)

summary(sUASndvi_yield_mixlm)

summary(sUASndvi_yield_mixlm)$tTable

Anova(sUASndvi_yield_mixlm , type = 2)
Anova(sUASndvi_yield_mixlm , type = 3)

r.squaredGLMM(sUASndvi_yield_mixlm)

```

#### diagnostics

```{r}

plot (sUASndvi_yield_mixlm)

plot(resid(sUASndvi_yield_mixlm, type = "normalized") ~fitted(sUASndvi_yield_mixlm))

sUASndvi_yield_mixlm_y <- resid(sUASndvi_yield_mixlm, type = "normalized")
sUASndvi_yield_mixlm_x <- fitted(sUASndvi_yield_mixlm)

sUASndvi_yield_mixlmresid_data <- data.frame(sUASndvi_yield_mixlm_x , sUASndvi_yield_mixlm_y)

ggplot( data = sUASndvi_yield_mixlmresid_data , aes( x = sUASndvi_yield_mixlm_x , y = sUASndvi_yield_mixlm_y)) +
  geom_point(mapping = aes(sUASndvi_yield_mixlm_x , sUASndvi_yield_mixlm_y) , data = sUASndvi_yield_mixlmresid_data)

hist(resid(sUASndvi_yield_mixlm))


plot(sUASndvi_yield_mixlm, site_year ~ resid(.), abline = 0)


qqnorm(sUASndvi_yield_mixlm, abline = c(0,1) )


qqnorm(resid(sUASndvi_yield_mixlm))
qqline(resid(sUASndvi_yield_mixlm))


qqnorm(sUASndvi_yield_mixlm , ~resid(.) | site_year)

plot(ranef(sUASndvi_yield_mixlm))

pairs(sUASndvi_yield_mixlm , id = 0.1) 

qqnorm(sUASndvi_yield_mixlm , ~ranef(.))

plot( sUASndvi_yield_mixlm, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

#### emmeans

```{r}

mylist <- list(SI=seq(round(min(paper3_uas_ndvi_data$SI), digits = 3) , 1 , by = .001))

sUASndvi_emmeans <- as.data.frame(summary(emmeans(sUASndvi_yield_mixlm , ~ SI , at = mylist )))

```

#### plot

```{r}

plot_si2 <- ggplot( data = paper3_uas_ndvi_data , aes( x = SI , y = GrainYield_Mgha)) +
  geom_point( data = paper3_uas_ndvi_data , aes( x = SI , y = GrainYield_Mgha , shape = site_year) , size = 7) +
  geom_line( data = sUASndvi_emmeans , aes(x = SI , y = emmean) , color = "blue" , size = 3.5) +
  theme_classic() +
  labs( x = NULL , y = NULL , shape = "Site-Year") +
  scale_x_continuous(breaks = seq(0.2 , 1 , by = .1)) +
  scale_y_continuous(breaks = seq(0 , 14 , by = 2)) +
  coord_cartesian(ylim = c(0,14) , xlim = c(0.27 , 1)) +
  geom_vline(xintercept = 1 , size = 0.75) +
  theme(axis.text = element_text(size = 38),
        axis.title = element_text(size = 38),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20 , hjust = 0.5),
        legend.position = c(.075 , .32),
        legend.box.background = element_rect(size = 1)) +
  annotate("text", x=0.26, y=11, label="R² = 0.53\np < 0.001\nslope = 25.3", size=10 , color="black" , hjust = 0) +
  annotate("text", x=0.26, y=14.1, label="(c)", size=10 , color = "black" , hjust = 0 , fontface = 2) +
  annotate("text", x=0.285, y=14, label="NDVI[UAS]", size=10 , color = "black" , hjust = 0 , parse = T) +
  scale_shape_manual(values = c(1:20))

plot_si2

```

### sUAS ndre RI

#### model

```{r}


sUASndre_yield_mixlm <- lme(fixed = GrainYield_Mgha ~ SI ,
                          random = ~I(SI) | site_year,
                          data = paper3_uas_ndre_data)

summary(sUASndre_yield_mixlm)

summary(sUASndre_yield_mixlm)$tTable

Anova(sUASndre_yield_mixlm , type = 2)
Anova(sUASndre_yield_mixlm , type = 3)

r.squaredGLMM(sUASndre_yield_mixlm)

```

#### diagnostics

```{r}

plot (sUASndre_yield_mixlm)

plot(resid(sUASndre_yield_mixlm, type = "normalized") ~fitted(sUASndre_yield_mixlm))

sUASndre_yield_mixlm_y <- resid(sUASndre_yield_mixlm, type = "normalized")
sUASndre_yield_mixlm_x <- fitted(sUASndre_yield_mixlm)

sUASndre_yield_mixlmresid_data <- data.frame(sUASndre_yield_mixlm_x , sUASndre_yield_mixlm_y)

ggplot( data = sUASndre_yield_mixlmresid_data , aes( x = sUASndre_yield_mixlm_x , y = sUASndre_yield_mixlm_y)) +
  geom_point(mapping = aes(sUASndre_yield_mixlm_x , sUASndre_yield_mixlm_y) , data = sUASndre_yield_mixlmresid_data)

hist(resid(sUASndre_yield_mixlm))


plot(sUASndre_yield_mixlm, site_year ~ resid(.), abline = 0)


qqnorm(sUASndre_yield_mixlm, abline = c(0,1) )


qqnorm(resid(sUASndre_yield_mixlm))
qqline(resid(sUASndre_yield_mixlm))


qqnorm(sUASndre_yield_mixlm , ~resid(.) | site_year)

plot(ranef(sUASndre_yield_mixlm))

pairs(sUASndre_yield_mixlm , id = 0.1) 

qqnorm(sUASndre_yield_mixlm , ~ranef(.))

plot( sUASndre_yield_mixlm, resid(., type = "p") ~ fitted(.) | site_year,
      id = 0.05, adj = -0.3 )

```

#### emmeans

```{r}

mylist <- list(SI=seq(round(min(paper3_uas_ndre_data$SI), digits = 3) , 1 , by = .001))

sUASndre_emmeans <- as.data.frame(summary(emmeans(sUASndre_yield_mixlm , ~ SI , at = mylist )))


```

#### plot

```{r}

plot_si3 <- ggplot( data = paper3_uas_ndre_data , aes( x = SI , y = GrainYield_Mgha)) +
  geom_point( data = paper3_uas_ndre_data , aes( x = SI , y = GrainYield_Mgha , shape = site_year) , size = 7) +
  geom_line( data = sUASndre_emmeans , aes(x = SI , y = emmean) , color = "blue" , size = 3.5) +
  theme_classic() +
  labs( x = NULL , y = NULL , shape = "Site-Year") +
  scale_x_continuous(breaks = seq(0.2 , 1 , by = .1)) +
  scale_y_continuous(breaks = seq(0 , 14 , by = 2)) +
  coord_cartesian(ylim = c(0,14) , xlim = c(0.27 , 1)) +
  geom_vline(xintercept = 1 , size = 0.5) +
  theme(axis.text = element_text(size = 38),
        axis.title = element_text(size = 38),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position = "none") +
  annotate("text", x=0.26, y=11, label="R² = 0.51\np < 0.001\nslope = 11.7", size=10 , color = "black" , hjust = 0) +
  annotate("text", x=0.26, y=14.1, label="(b)", size=10 , color = "black" , hjust = 0 , fontface = 2) +
  annotate("text", x=0.285, y=14, label="NDRE[UAS]", size=10 , color = "black" , hjust = 0 , parse = T) +
  scale_shape_manual(values = c(1:20))

plot_si3

```


### FIGURE 6

```{r}

Fig5 <- grid.arrange(arrangeGrob(plot_si1,
                                 plot_si3,
                                 plot_si2,
                                 nrow = 3,
                                 ncol = 1,
                                 left = textGrob("Grain Yield ( Mg ha"^-1~")" , rot = 90 , gp = gpar(fontsize = 44)),
                                 bottom = textGrob("Sufficiency Index" , gp = gpar(fontsize = 44))))

ggsave("FIGURES/Fig5.tiff" , Fig5 , compression = "lzw" , width = 22 , height = 22, type = "cairo" , dpi = 750)
```



